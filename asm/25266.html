<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at 25266</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Skool Daze" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="25248.html">25248</a></span></td>
<td class="up">Up: <a href="../maps/all.html#25266">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="25303.html">25303</a></span></td>
</tr>
</table>
<div class="description">25266: Determine whether a character should be moved (1)</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="25126.html">25126</a>. Returns to that routine if the character under consideration should be moved on this pass; otherwise drops the return address from the stack, thus skipping ahead to consider the next character. Also reinitialises the walking speed change delay counter in byte 123 of the character's buffer when it reaches 0, and sets the new walking speed as appropriate: slow for teachers, fast or slow (at random) for boys.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (152-171)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="25266"></span>25266</td>
<td class="instruction">LD L,123</td>
<td class="comment-11" rowspan="2">Byte 123 contains a counter that is reset to a random even number between 2 and 32; see below</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25268"></span>25268</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25269"></span>25269</td>
<td class="instruction">JR Z,25280</td>
<td class="comment-11" rowspan="1">Jump if it's time to consider a change of pace</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25271"></span>25271</td>
<td class="instruction">BIT 0,(HL)</td>
<td class="comment-11" rowspan="1">Is the counter even?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25273"></span>25273</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return (to move the character) if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25274"></span>25274</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=122</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25275"></span>25275</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Is this character walking fast?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25277"></span>25277</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return (to move the character) if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25278"></span>25278</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Drop the return address from the stack so that the character will not be moved this time round</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25279"></span>25279</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Return to consider the next character, or return to the main loop</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="25280"></span>
<div class="comments">
<div class="paragraph">
It's time to consider a change of pace for the character being moved.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="25280"></span>25280</td>
<td class="instruction">CALL <a href="24993.html">24993</a></td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=random number</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25283"></span>25283</td>
<td class="instruction">AND 61</td>
<td class="comment-11" rowspan="3"><span class="register">A</span>=even number between 2 and 32, and the carry flag holds a random bit</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25285"></span>25285</td>
<td class="instruction">ADD A,4</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25287"></span>25287</td>
<td class="instruction">RRA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25288"></span>25288</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">Place this even number into byte 123 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25289"></span>25289</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=122</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25290"></span>25290</td>
<td class="instruction">RL (HL)</td>
<td class="comment-11" rowspan="2">Bit 7 of byte 122 is now equal to the random bit that was pushed into the carry flag by the RRA instruction above</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25292"></span>25292</td>
<td class="instruction">RRC (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25294"></span>25294</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">Bit 5 of byte 122 is set for catapult pellets and stampeding boys to ensure they always go at top speed</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25295"></span>25295</td>
<td class="instruction">BIT 5,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25297"></span>25297</td>
<td class="instruction">JR Z,<a href="25367.html">25367</a></td>
<td class="comment-11" rowspan="1">Jump if we're not dealing with such a thing</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25299"></span>25299</td>
<td class="instruction">RES 7,(HL)</td>
<td class="comment-11" rowspan="1">Signal: fly or run at top speed</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25301"></span>25301</td>
<td class="instruction">JR <a href="25367.html">25367</a></td>
<td class="comment-11" rowspan="1">Jump over the routine at <a href="25303.html">25303</a></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="25248.html">25248</a></span></td>
<td class="up">Up: <a href="../maps/all.html#25266">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="25303.html">25303</a></span></td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze RAM disassembly 20151011</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd (Skool Daze). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 5.0.</div>
</footer>
</body>
</html>