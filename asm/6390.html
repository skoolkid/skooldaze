<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at 6390</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Skool Daze" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="638C.html">638C</a></span></td>
<td class="up">Up: <a href="../maps/all.html#6390">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="63BC.html">63BC</a></span></td>
</tr>
</table>
<div class="description">6390: Guide a character down a staircase</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
The address of this interruptible subcommand routine is placed into bytes 0x69 and 0x6A of a character's buffer by the routine at <a href="63BE.html">63BE</a> when the character has reached the top of a staircase he needs to descend to reach his destination.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (0x98-0xA9)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6390"></span>6390</td>
<td class="instruction">LD B,$01</td>
<td class="comment-11" rowspan="1">Signal that the character is going down a staircase</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="6392"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="638C.html">638C</a> with <span class="register">B</span>=0xFF.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="6392"></span>6392</td>
<td class="instruction">LD L,$6B</td>
<td class="comment-11" rowspan="1">Byte 0x6B of the character's buffer holds the number of movements remaining</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6394"></span>6394</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-11" rowspan="1">Has the character finished going up or down the stairs?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6395"></span>6395</td>
<td class="instruction">JP Z,<a href="62A0.html#62a4">$62A4</a></td>
<td class="comment-11" rowspan="1">Terminate this interruptible subcommand if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6398"></span>6398</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Save the direction indicator (in <span class="register">B</span>) briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="6399"></span>6399</td>
<td class="instruction">CALL <a href="6214.html">$6214</a></td>
<td class="comment-11" rowspan="1">Update the SRB for the character's current location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="639c"></span>639C</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Restore the direction indicator to <span class="register">B</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="639d"></span>639D</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1"><span class="register">C</span>=character's current animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="639e"></span>639E</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's next animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="639f"></span>639F</td>
<td class="instruction">BIT 0,A</td>
<td class="comment-11" rowspan="1">Is the character midstride right now?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63a1"></span>63A1</td>
<td class="instruction">JR Z,$63AB</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="63a3"></span>
<div class="comments">
<div class="paragraph">
The following four instructions calculate the character's next y-coordinate. The y-coordinate will be decremented if the character is going up the stairs and he's not midstride at the moment, incremented if he's going down the stairs and he is midstride at the moment, and otherwise unchanged.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63a3"></span>63A3</td>
<td class="instruction">DEC D</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="63a4"></span>63A4</td>
<td class="instruction">INC B</td>
<td class="comment-11" rowspan="1">Is the character going up the stairs?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63a5"></span>63A5</td>
<td class="instruction">JR Z,$63A8</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63a7"></span>63A7</td>
<td class="instruction">INC D</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="63a8"></span>
<div class="comments">
<div class="paragraph">
At this point <span class="register">A</span> holds the character's new animatory state, and <span class="register">DE</span> his new location.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="63a8"></span>63A8</td>
<td class="instruction">JP <a href="61B0.html">$61B0</a></td>
<td class="comment-11" rowspan="1">Update the character's animatory state and location and update the SRB</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<span id="63ab"></span>
<div class="comments">
<div class="paragraph">
The character is midstride. Now we calculate his next x-coordinate.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="63ab"></span>63AB</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="2">Set the carry flag if the character is facing left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63ac"></span>63AC</td>
<td class="instruction">CCF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63ad"></span>63AD</td>
<td class="instruction">SBC A,A</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=0 (facing right) or -2 (facing left)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63ae"></span>63AE</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63af"></span>63AF</td>
<td class="instruction">ADD A,E</td>
<td class="comment-11" rowspan="3">Set <span class="register">E</span> equal to the character's new x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63b0"></span>63B0</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63b1"></span>63B1</td>
<td class="instruction">INC E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63b2"></span>63B2</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's current animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63b3"></span>63B3</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's next animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63b4"></span>63B4</td>
<td class="instruction">BIT 1,A</td>
<td class="comment-11" rowspan="1">Will the character be standing (phase 3)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63b6"></span>63B6</td>
<td class="instruction">JR NZ,$63A4</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63b8"></span>63B8</td>
<td class="instruction">SUB $04</td>
<td class="comment-11" rowspan="1">Adjust the animatory state to standing (phase 1)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="63ba"></span>63BA</td>
<td class="instruction">JR $63A4</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="638C.html">638C</a></span></td>
<td class="up">Up: <a href="../maps/all.html#6390">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="63BC.html">63BC</a></span></td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze RAM disassembly 20181018</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd. &#169; 2018 Richard Dymond.</div>
<div class="created">Created using <a href="http://skoolkit.ca/">SkoolKit</a> 7.0.</div>
<div><a href="http://skoolkit.ca/disassemblies/skool_daze/asm/25488.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>