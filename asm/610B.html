<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at 610B</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Skool Daze" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="6100.html">6100</a>
</td>
<td class="up">Up: <a href="../maps/all.html#610b">Map</a></td>
<td class="next">
Next: <a href="6183.html">6183</a>
</td>
</tr>
</table>
<div class="description">610B: Print a tile</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="6000.html">6000</a> and <a href="6992.html">6992</a>. Copies a tile of the skool into the back buffer at <a href="7F01.html">7F01</a>, superimposes character sprite tiles as appropriate, and then copies the resultant tile to the screen.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">D</td>
<td class="register-desc">Skool y-coordinate (152-172)</td>
</tr>
<tr>
<td class="register">E</td>
<td class="register-desc">Skool x-coordinate (0-95)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="610b"></span>610B</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=skool x-coordinate (0-95)</td>
</tr>
<tr>
<td class="address-1"><span id="610c"></span>610C</td>
<td class="instruction">AND $60</td>
<td class="comment-1" rowspan="5">Now <span class="register">H</span> is 0x80 if 0&lt;=<span class="register">E</span>&lt;32; 0x88 if 32&lt;=<span class="register">E</span>&lt;64; or 0x90 if 64&lt;=<span class="register">E</span>&lt;96</td>
</tr>
<tr>
<td class="address-1"><span id="610e"></span>610E</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="610f"></span>610F</td>
<td class="instruction">INC A</td>
</tr>
<tr>
<td class="address-1"><span id="6110"></span>6110</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="6111"></span>6111</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="6112"></span>6112</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=skool UDG reference for the character square at (<span class="register">E</span>,<span class="register">D</span>)</td>
</tr>
<tr>
<td class="address-1"><span id="6113"></span>6113</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="6114"></span>6114</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=base address of the UDG bytes for the character square at (<span class="register">E</span>,<span class="register">D</span>)</td>
</tr>
<tr>
<td class="address-1"><span id="6115"></span>6115</td>
<td class="instruction">LD BC,$0800</td>
<td class="comment-1" rowspan="1"><span class="register">B</span>=8, <span class="register">C</span>=0</td>
</tr>
<tr>
<td class="address-1"><span id="6118"></span>6118</td>
<td class="instruction">LD DE,$7F01</td>
<td class="comment-1" rowspan="6">Copy the 8 bytes of the skool UDG into the back buffer at <a href="7F01.html">7F01</a></td>
</tr>
<tr>
<td class="address-2"><span id="611b"></span>611B</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="611c"></span>611C</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="address-1"><span id="611d"></span>611D</td>
<td class="instruction">INC H</td>
</tr>
<tr>
<td class="address-1"><span id="611e"></span>611E</td>
<td class="instruction">INC E</td>
</tr>
<tr>
<td class="address-1"><span id="611f"></span>611F</td>
<td class="instruction">DJNZ $611B</td>
</tr>
<tr>
<td class="address-1"><span id="6121"></span>6121</td>
<td class="instruction">NOP</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="6122"></span>6122</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Restore the skool coordinates to <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="6123"></span>6123</td>
<td class="instruction">LD B,$15</td>
<td class="comment-1" rowspan="1">There are 21 characters to consider</td>
</tr>
<tr>
<td class="address-1"><span id="6125"></span>6125</td>
<td class="instruction">LD H,$98</td>
<td class="comment-1" rowspan="1">0x98=little boy no. 1</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="6127"></span>
<div class="comments">
<div class="paragraph">
Now we enter a loop that checks which part (if any) of each character's sprite appears at the skool coordinates in <span class="register">DE</span>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="6127"></span>6127</td>
<td class="instruction">LD L,$62</td>
<td class="comment-1" rowspan="1">Byte 0x62 of the character's buffer holds his x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="6129"></span>6129</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=skool x-coordinate (0-95)</td>
</tr>
<tr>
<td class="address-1"><span id="612a"></span>612A</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-1" rowspan="1">Subtract the character's x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="612b"></span>612B</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">Byte 0x61 of the character's buffer holds his y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="612c"></span>612C</td>
<td class="instruction">JR C,$615E</td>
<td class="comment-1" rowspan="3">Jump if no part of the character's sprite appears at this x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="612e"></span>612E</td>
<td class="instruction">CP $03</td>
</tr>
<tr>
<td class="address-1"><span id="6130"></span>6130</td>
<td class="instruction">JR NC,$615E</td>
</tr>
<tr>
<td class="address-1"><span id="6132"></span>6132</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="3">Now <span class="register">C</span> is 0, 4 or 8, corresponding to the column (left, middle or right) of the character's sprite that aligns with x-coordinate <span class="register">E</span></td>
</tr>
<tr>
<td class="address-1"><span id="6133"></span>6133</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="6134"></span>6134</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="address-1"><span id="6135"></span>6135</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=skool y-coordinate (152-172)</td>
</tr>
<tr>
<td class="address-1"><span id="6136"></span>6136</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-1" rowspan="1">Subtract the character's y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="6137"></span>6137</td>
<td class="instruction">JR C,$615E</td>
<td class="comment-1" rowspan="3">Jump if no part of the character's sprite appears at this y-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="6139"></span>6139</td>
<td class="instruction">CP $04</td>
</tr>
<tr>
<td class="address-1"><span id="613b"></span>613B</td>
<td class="instruction">JR NC,$615E</td>
</tr>
<tr>
<td class="address-1"><span id="613d"></span>613D</td>
<td class="instruction">ADD A,C</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=0x00-0x0B, corresponding to the sprite tile that appears at (<span class="register">E</span>,<span class="register">D</span>)</td>
</tr>
<tr>
<td class="address-1"><span id="613e"></span>613E</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="613f"></span>613F</td>
<td class="instruction">ADD A,$AD</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="6141"></span>6141</td>
<td class="instruction">LD H,A</td>
<td class="comment-1" rowspan="1"><span class="register">H'</span>=0xAD-0xB8</td>
</tr>
<tr>
<td class="address-1"><span id="6142"></span>6142</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="6143"></span>6143</td>
<td class="instruction">LD L,$60</td>
<td class="comment-1" rowspan="2">Pick up the character's animatory state in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="6145"></span>6145</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="6146"></span>6146</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="6147"></span>6147</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1"><span class="register">L'</span>=character's animatory state</td>
</tr>
<tr>
<td class="address-1"><span id="6148"></span>6148</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=sprite tile UDG reference</td>
</tr>
<tr>
<td class="address-1"><span id="6149"></span>6149</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is it the blank UDG?</td>
</tr>
<tr>
<td class="address-1"><span id="614a"></span>614A</td>
<td class="instruction">JR Z,$615D</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="614c"></span>614C</td>
<td class="instruction">CALL <a href="6D0A.html">$6D0A</a></td>
<td class="comment-1" rowspan="1">Get the base address of the sprite tile UDG bytes in <span class="register">HL'</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="614f"></span>
<div class="comments">
<div class="paragraph">
The following inner loop superimposes the sprite tile onto the tile built up so far in the back buffer at <a href="7F01.html">7F01</a> (which was originally populated with the relevant skool UDG).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="614f"></span>614F</td>
<td class="instruction">LD B,$08</td>
<td class="comment-1" rowspan="1">There are 8 bytes in the UDG</td>
</tr>
<tr>
<td class="address-1"><span id="6151"></span>6151</td>
<td class="instruction">LD DE,$7F01</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="6154"></span>6154</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=back buffer UDG byte</td>
</tr>
<tr>
<td class="address-1"><span id="6155"></span>6155</td>
<td class="instruction">OR (HL)</td>
<td class="comment-1" rowspan="1">OR in the sprite tile UDG byte</td>
</tr>
<tr>
<td class="address-1"><span id="6156"></span>6156</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="6157"></span>6157</td>
<td class="instruction">AND (HL)</td>
<td class="comment-1" rowspan="1">AND in the sprite tile UDG mask</td>
</tr>
<tr>
<td class="address-1"><span id="6158"></span>6158</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="6159"></span>6159</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="615a"></span>615A</td>
<td class="instruction">INC E</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="615b"></span>615B</td>
<td class="instruction">DJNZ $6154</td>
<td class="comment-1" rowspan="1">Jump back until the UDG is done</td>
</tr>
<tr>
<td class="address-2"><span id="615d"></span>615D</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="615e"></span>615E</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="1">Next character</td>
</tr>
<tr>
<td class="address-1"><span id="615f"></span>615F</td>
<td class="instruction">DJNZ $6127</td>
<td class="comment-1" rowspan="1">Jump back to consider the next character</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="6161"></span>
<div class="comments">
<div class="paragraph">
The display tile (consisting of the skool UDG with all relevant sprite tiles superimposed) has been built. Figure out where in the display file it should be printed.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="6161"></span>6161</td>
<td class="instruction">LD HL,$7F00</td>
<td class="comment-1" rowspan="1"><a href="7F00.html">7F00</a> holds the leftmost column of the skool on-screen (0-64)</td>
</tr>
<tr>
<td class="address-1"><span id="6164"></span>6164</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=skool y-coordinate (152-172)</td>
</tr>
<tr>
<td class="address-1"><span id="6165"></span>6165</td>
<td class="instruction">AND $07</td>
<td class="comment-1" rowspan="5">Set <span class="register">C</span> to the LSB of the display file address corresponding to the screen coordinates (0,<span class="register">D</span>-152)</td>
</tr>
<tr>
<td class="address-1"><span id="6167"></span>6167</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="6168"></span>6168</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="6169"></span>6169</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="616a"></span>616A</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="address-1"><span id="616b"></span>616B</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=screen x-coordinate (0-31)</td>
</tr>
<tr>
<td class="address-1"><span id="616c"></span>616C</td>
<td class="instruction">SUB (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="616d"></span>616D</td>
<td class="instruction">ADD A,C</td>
<td class="comment-1" rowspan="2">Set <span class="register">L</span> to the LSB of the display file address corresponding to the skool coordinates (<span class="register">E</span>,<span class="register">D</span>)</td>
</tr>
<tr>
<td class="address-1"><span id="616e"></span>616E</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="616f"></span>616F</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=screen y-coordinate (0-20)</td>
</tr>
<tr>
<td class="address-1"><span id="6170"></span>6170</td>
<td class="instruction">SUB $98</td>
</tr>
<tr>
<td class="address-1"><span id="6172"></span>6172</td>
<td class="instruction">AND $18</td>
<td class="comment-1" rowspan="3">Set <span class="register">H</span> to the MSB of the display file address corresponding to the skool coordinates (<span class="register">E</span>,<span class="register">D</span>)</td>
</tr>
<tr>
<td class="address-1"><span id="6174"></span>6174</td>
<td class="instruction">ADD A,$40</td>
</tr>
<tr>
<td class="address-1"><span id="6176"></span>6176</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="6177"></span>
<div class="comments">
<div class="paragraph">
Having computed the appropriate display file address in <span class="register">HL</span>, copy the tile from the back buffer to the screen.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="6177"></span>6177</td>
<td class="instruction">LD B,$08</td>
<td class="comment-1" rowspan="7">Copy the tile to the screen</td>
</tr>
<tr>
<td class="address-1"><span id="6179"></span>6179</td>
<td class="instruction">LD DE,$7F01</td>
</tr>
<tr>
<td class="address-2"><span id="617c"></span>617C</td>
<td class="instruction">LD A,(DE)</td>
</tr>
<tr>
<td class="address-1"><span id="617d"></span>617D</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="617e"></span>617E</td>
<td class="instruction">INC H</td>
</tr>
<tr>
<td class="address-1"><span id="617f"></span>617F</td>
<td class="instruction">INC E</td>
</tr>
<tr>
<td class="address-1"><span id="6180"></span>6180</td>
<td class="instruction">DJNZ $617C</td>
</tr>
<tr>
<td class="address-1"><span id="6182"></span>6182</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="6100.html">6100</a>
</td>
<td class="up">Up: <a href="../maps/all.html#610b">Map</a></td>
<td class="next">
Next: <a href="6183.html">6183</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze RAM disassembly 20210310</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd. &#169; 2021 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.4.</div>
<div><a href="../dec/asm/24843.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>