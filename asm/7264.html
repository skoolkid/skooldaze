<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at 7264</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Skool Daze" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="725E.html">725E</a>
</td>
<td class="up">Up: <a href="../maps/all.html#7264">Map</a></td>
<td class="next">
Next: <a href="72C9.html">72C9</a>
</td>
</tr>
</table>
<div class="description">7264: Make a character write on a blackboard</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
The address of this interruptible subcommand routine is placed into bytes 0x69 and 0x6A of a character's buffer by the routines at <a href="7D30.html">7D30</a>, <a href="7D9E.html">7D9E</a> and <a href="F300.html">F300</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (0xA3-0xA7)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="7264"></span>7264</td>
<td class="instruction">CALL <a href="7128.html">$7128</a></td>
<td class="comment-1" rowspan="1">Collect the identifier of the nearest blackboard in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="7267"></span>7267</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="3"><span class="register">BC</span>=<a href="7FED.html">7FED</a> (Reading Room blackboard), <a href="7FEF.html">7FEF</a> (White Room blackboard), or <a href="7FF1.html">7FF1</a> (Exam Room blackboard)</td>
</tr>
<tr>
<td class="address-1"><span id="7268"></span>7268</td>
<td class="instruction">LD B,$7F</td>
</tr>
<tr>
<td class="address-1"><span id="726a"></span>726A</td>
<td class="instruction">INC C</td>
</tr>
<tr>
<td class="address-1"><span id="726b"></span>726B</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=number of the character who last wrote on the board</td>
</tr>
<tr>
<td class="address-1"><span id="726c"></span>726C</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is the board dirty?</td>
</tr>
<tr>
<td class="address-1"><span id="726d"></span>726D</td>
<td class="instruction">JP NZ,<a href="62A0.html#62a4">$62A4</a></td>
<td class="comment-1" rowspan="1">Terminate this interruptible subcommand if so</td>
</tr>
<tr>
<td class="address-1"><span id="7270"></span>7270</td>
<td class="instruction">NOP</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="7271"></span>7271</td>
<td class="instruction">NOP</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="7272"></span>7272</td>
<td class="instruction">NOP</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7273"></span>
<div class="comments">
<div class="paragraph">
The board is clean, so the character can go ahead and write on it.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="7273"></span>7273</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="2">Store this character's number in the blackboard buffer, indicating that he wrote on it</td>
</tr>
<tr>
<td class="address-1"><span id="7274"></span>7274</td>
<td class="instruction">LD (BC),A</td>
</tr>
<tr>
<td class="address-1"><span id="7275"></span>7275</td>
<td class="instruction">LD L,$6E</td>
<td class="comment-1" rowspan="4">Zero out bytes 0x6D and 0x6E of the character's buffer (which hold the submessage address)</td>
</tr>
<tr>
<td class="address-1"><span id="7277"></span>7277</td>
<td class="instruction">LD (HL),$00</td>
</tr>
<tr>
<td class="address-1"><span id="7279"></span>7279</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="address-1"><span id="727a"></span>727A</td>
<td class="instruction">LD (HL),$00</td>
</tr>
<tr>
<td class="address-1"><span id="727c"></span>727C</td>
<td class="instruction">ADD A,$43</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=0xEA (BOY WANDER) or 0xE6-0xE9 (a teacher)</td>
</tr>
<tr>
<td class="address-1"><span id="727e"></span>727E</td>
<td class="instruction">CP $EA</td>
<td class="comment-1" rowspan="1">Are we dealing with a teacher?</td>
</tr>
<tr>
<td class="address-1"><span id="7280"></span>7280</td>
<td class="instruction">JR C,$7284</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="7282"></span>7282</td>
<td class="instruction">LD A,$E5</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=0xE5 if we're dealing with BOY WANDER</td>
</tr>
<tr>
<td class="address-2"><span id="7284"></span>7284</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="2"><span class="register">A</span> holds the MSB of the blackboard message address; store this in byte 0x6C of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="7285"></span>7285</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="7286"></span>7286</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="4">Get a random multiple of 32 in <span class="register">A</span>; this will be the LSB of the blackboard message address, which is stored in byte 0x6B of the character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="7287"></span>7287</td>
<td class="instruction">CALL <a href="61A1.html">$61A1</a></td>
</tr>
<tr>
<td class="address-1"><span id="728a"></span>728A</td>
<td class="instruction">AND $E0</td>
</tr>
<tr>
<td class="address-1"><span id="728c"></span>728C</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="728d"></span>728D</td>
<td class="instruction">LD L,$69</td>
<td class="comment-1" rowspan="2">Replace the address of this routine in bytes 0x69 and 0x6A of the character's buffer with that of the entry point at <a href="7264.html#7291">7291</a> (below)</td>
</tr>
<tr>
<td class="address-1"><span id="728f"></span>728F</td>
<td class="instruction">LD (HL),$91</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7291"></span>
<div class="comments">
<div class="paragraph">
This entry point is used on subsequent calls.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="7291"></span>7291</td>
<td class="instruction">CALL <a href="7142.html">$7142</a></td>
<td class="comment-1" rowspan="1">Write a single letter on the blackboard</td>
</tr>
<tr>
<td class="address-1"><span id="7294"></span>7294</td>
<td class="instruction">JR NZ,$72A7</td>
<td class="comment-1" rowspan="1">Jump unless the character has finished writing</td>
</tr>
<tr>
<td class="address-1"><span id="7296"></span>7296</td>
<td class="instruction">CALL <a href="6214.html">$6214</a></td>
<td class="comment-1" rowspan="1">Update the SRB for the character's current animatory state</td>
</tr>
<tr>
<td class="address-1"><span id="7299"></span>7299</td>
<td class="instruction">AND $F8</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=base animatory state of the teacher writing on the board</td>
</tr>
<tr>
<td class="address-1"><span id="729b"></span>729B</td>
<td class="instruction">BIT 6,A</td>
<td class="comment-1" rowspan="1">Is it actually a teacher writing on the board?</td>
</tr>
<tr>
<td class="address-1"><span id="729d"></span>729D</td>
<td class="instruction">JR NZ,$72A1</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="729f"></span>729F</td>
<td class="instruction">AND $F0</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=base animatory state of BOY WANDER</td>
</tr>
<tr>
<td class="address-2"><span id="72a1"></span>72A1</td>
<td class="instruction">CALL <a href="61B0.html">$61B0</a></td>
<td class="comment-1" rowspan="1">Update the character's animatory state and update the SRB</td>
</tr>
<tr>
<td class="address-1"><span id="72a4"></span>72A4</td>
<td class="instruction">JP <a href="62A0.html#62a4">$62A4</a></td>
<td class="comment-1" rowspan="1">Terminate this interruptible subcommand</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="72a7"></span>
<div class="comments">
<div class="paragraph">
The character hasn't finished writing on the board yet.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="72a7"></span>72A7</td>
<td class="instruction">CALL <a href="6214.html">$6214</a></td>
<td class="comment-1" rowspan="1">Update the SRB for the character's current animatory state</td>
</tr>
<tr>
<td class="address-1"><span id="72aa"></span>72AA</td>
<td class="instruction">BIT 6,A</td>
<td class="comment-1" rowspan="1">Set the zero flag if BOY WANDER is writing on the board</td>
</tr>
<tr>
<td class="address-1"><span id="72ac"></span>72AC</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1"><span class="register">B</span>=character's current animatory state</td>
</tr>
<tr>
<td class="address-1"><span id="72ad"></span>72AD</td>
<td class="instruction">JR NZ,$72BF</td>
<td class="comment-1" rowspan="1">Jump if a teacher is writing on the board</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="72af"></span>
<div class="comments">
<div class="paragraph">
BOY WANDER is writing on the board. Determine his next animatory state: <a href="../graphics/as.html#60">0x3C/0xBC</a> or <a href="../graphics/as.html#61">0x3D/0xBD</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="72af"></span>72AF</td>
<td class="instruction">AND $7F</td>
<td class="comment-1" rowspan="1">Drop the direction bit (bit 7) for now</td>
</tr>
<tr>
<td class="address-1"><span id="72b1"></span>72B1</td>
<td class="instruction">CP $3C</td>
<td class="comment-1" rowspan="1"><a href="../graphics/as.html#60">0x3C</a>=BOY WANDER writing (phase 1)</td>
</tr>
<tr>
<td class="address-1"><span id="72b3"></span>72B3</td>
<td class="instruction">LD A,$7A</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>/2=<a href="../graphics/as.html#61">0x3D</a>=BOY WANDER writing (phase 2)</td>
</tr>
<tr>
<td class="address-1"><span id="72b5"></span>72B5</td>
<td class="instruction">JR Z,$72B9</td>
<td class="comment-1" rowspan="1">Jump if BOY WANDER is in writing phase 1</td>
</tr>
<tr>
<td class="address-1"><span id="72b7"></span>72B7</td>
<td class="instruction">LD A,$78</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>/2=<a href="../graphics/as.html#60">0x3C</a>=BOY WANDER writing (phase 1)</td>
</tr>
<tr>
<td class="address-2"><span id="72b9"></span>72B9</td>
<td class="instruction">RL B</td>
<td class="comment-1" rowspan="2">Slide the direction bit into bit 7 of <span class="register">A</span>, which will then hold BOY WANDER's next animatory state</td>
</tr>
<tr>
<td class="address-1"><span id="72bb"></span>72BB</td>
<td class="instruction">RRA</td>
</tr>
<tr>
<td class="address-1"><span id="72bc"></span>72BC</td>
<td class="instruction">JP <a href="61B0.html">$61B0</a></td>
<td class="comment-1" rowspan="1">Update BOY WANDER's animatory state and update the SRB</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="72bf"></span>
<div class="comments">
<div class="paragraph">
A teacher is writing on the board. Toggle the status of his arm (up/down).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="72bf"></span>72BF</td>
<td class="instruction">AND $F8</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=base animatory state of the teacher</td>
</tr>
<tr>
<td class="address-1"><span id="72c1"></span>72C1</td>
<td class="instruction">CP B</td>
<td class="comment-1" rowspan="1">Is the teacher's arm raised?</td>
</tr>
<tr>
<td class="address-1"><span id="72c2"></span>72C2</td>
<td class="instruction">JR NZ,$72C6</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="72c4"></span>72C4</td>
<td class="instruction">ADD A,$05</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=animatory state of the teacher with his arm raised</td>
</tr>
<tr>
<td class="address-2"><span id="72c6"></span>72C6</td>
<td class="instruction">JP <a href="61B0.html">$61B0</a></td>
<td class="comment-1" rowspan="1">Update the teacher's animatory state and update the SRB</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="725E.html">725E</a>
</td>
<td class="up">Up: <a href="../maps/all.html#7264">Map</a></td>
<td class="next">
Next: <a href="72C9.html">72C9</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze RAM disassembly 20210310</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd. &#169; 2021 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.4.</div>
<div><a href="../dec/asm/29284.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>