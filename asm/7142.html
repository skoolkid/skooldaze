<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at 7142</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Skool Daze" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="7128.html">7128</a>
</td>
<td class="up">Up: <a href="../maps/all.html#7142">Map</a></td>
<td class="next">
Next: <a href="71D1.html">71D1</a>
</td>
</tr>
</table>
<div class="description">7142: Write a single character on a blackboard</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="7264.html">7264</a>. Returns with the zero flag set if the end of the message has been reached.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Number of the character writing on the board (0xA3-0xA7)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="7142"></span>7142</td>
<td class="instruction">CALL <a href="70D2.html">$70D2</a></td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=next character in the message being written</td>
</tr>
<tr>
<td class="address-1"><span id="7145"></span>7145</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Save this in <span class="register">B</span> briefly</td>
</tr>
<tr>
<td class="address-1"><span id="7146"></span>7146</td>
<td class="instruction">CALL <a href="7128.html">$7128</a></td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=identifier of the blackboard being written on</td>
</tr>
<tr>
<td class="address-1"><span id="7149"></span>7149</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Transfer this to <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="714a"></span>714A</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=next character in the message being written</td>
</tr>
<tr>
<td class="address-1"><span id="714b"></span>714B</td>
<td class="instruction">LD B,$7F</td>
<td class="comment-1" rowspan="1">Point <span class="register">BC</span> at the appropriate blackboard buffer</td>
</tr>
<tr>
<td class="address-1"><span id="714d"></span>714D</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is the message finished?</td>
</tr>
<tr>
<td class="address-1"><span id="714e"></span>714E</td>
<td class="instruction">JR NZ,$7154</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="7150"></span>7150</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=0xFF</td>
</tr>
<tr>
<td class="address-2"><span id="7151"></span>7151</td>
<td class="instruction">LD (BC),A</td>
<td class="comment-1" rowspan="1">Store the pixel coordinates of the next character to be written on the board</td>
</tr>
<tr>
<td class="address-1"><span id="7152"></span>7152</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1">Set the zero flag if the message is finished</td>
</tr>
<tr>
<td class="address-1"><span id="7153"></span>7153</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7154"></span>
<div class="comments">
<div class="paragraph">
The character has not finished writing on the blackboard. <span class="register">A</span> holds the ASCII code of the next letter to be written.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="7154"></span>7154</td>
<td class="instruction">CP $02</td>
<td class="comment-1" rowspan="1">Is it newline?</td>
</tr>
<tr>
<td class="address-1"><span id="7156"></span>7156</td>
<td class="instruction">JR NZ,$715F</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="7158"></span>7158</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="3">Pick up the contents of <a href="7FEC.html">7FEC</a> (Reading Room blackboard), <a href="7FEE.html">7FEE</a> (White Room blackboard) or <a href="7FF0.html">7FF0</a> (Exam Room blackboard) and set it to 0 (start of top line) or 64 (start of bottom line)</td>
</tr>
<tr>
<td class="address-1"><span id="7159"></span>7159</td>
<td class="instruction">AND $40</td>
</tr>
<tr>
<td class="address-1"><span id="715b"></span>715B</td>
<td class="instruction">XOR $40</td>
</tr>
<tr>
<td class="address-1"><span id="715d"></span>715D</td>
<td class="instruction">JR $7151</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="715f"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="F6AA.html">F6AA</a> when ERIC is writing on a blackboard with <span class="register">BC</span>=<a href="7FA8.html#7fac">7FAC</a> (Reading Room blackboard), <a href="7FAE.html#7fb2">7FB2</a> (White Room blackboard), or <a href="7FB4.html#7fb8">7FB8</a> (Exam Room blackboard).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="715f"></span>715F</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="7160"></span>7160</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL</span> at the address holding the pixel width of the character to be written on the board</td>
</tr>
<tr>
<td class="address-1"><span id="7161"></span>7161</td>
<td class="instruction">LD H,$D9</td>
</tr>
<tr>
<td class="address-1"><span id="7163"></span>7163</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=pixel coordinates (0-127) of the location at which the character will be written</td>
</tr>
<tr>
<td class="address-1"><span id="7164"></span>7164</td>
<td class="instruction">AND $3F</td>
<td class="comment-1" rowspan="1">Discard bit 6 (the line indicator bit)</td>
</tr>
<tr>
<td class="address-1"><span id="7166"></span>7166</td>
<td class="instruction">ADD A,$C0</td>
<td class="comment-1" rowspan="3">Set the carry flag if there is not enough space at the end of the current line to print the character</td>
</tr>
<tr>
<td class="address-1"><span id="7168"></span>7168</td>
<td class="instruction">SCF</td>
</tr>
<tr>
<td class="address-1"><span id="7169"></span>7169</td>
<td class="instruction">ADC A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="716a"></span>716A</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=pixel coordinates (0-127)</td>
</tr>
<tr>
<td class="address-1"><span id="716b"></span>716B</td>
<td class="instruction">JR NC,$7172</td>
<td class="comment-1" rowspan="1">Jump if there is enough space to print the character on the current line</td>
</tr>
<tr>
<td class="address-1"><span id="716d"></span>716D</td>
<td class="instruction">AND $40</td>
<td class="comment-1" rowspan="3">Otherwise toggle which line (top or bottom) to write on and reset the pixel x-coordinate to 0 (start of the line)</td>
</tr>
<tr>
<td class="address-1"><span id="716f"></span>716F</td>
<td class="instruction">XOR $40</td>
</tr>
<tr>
<td class="address-1"><span id="7171"></span>7171</td>
<td class="instruction">LD (BC),A</td>
</tr>
<tr>
<td class="address-2"><span id="7172"></span>7172</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="10">Compute the skool coordinates of the location of the character to be written and store them in <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="7173"></span>7173</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="7174"></span>7174</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="7175"></span>7175</td>
<td class="instruction">AND $0F</td>
</tr>
<tr>
<td class="address-1"><span id="7177"></span>7177</td>
<td class="instruction">CP $08</td>
</tr>
<tr>
<td class="address-1"><span id="7179"></span>7179</td>
<td class="instruction">JR C,$717E</td>
</tr>
<tr>
<td class="address-1"><span id="717b"></span>717B</td>
<td class="instruction">INC D</td>
</tr>
<tr>
<td class="address-1"><span id="717c"></span>717C</td>
<td class="instruction">AND $07</td>
</tr>
<tr>
<td class="address-2"><span id="717e"></span>717E</td>
<td class="instruction">ADD A,E</td>
</tr>
<tr>
<td class="address-1"><span id="717f"></span>717F</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="7180"></span>7180</td>
<td class="instruction">CALL <a href="7087.html">$7087</a></td>
<td class="comment-1" rowspan="1">Update the screen refresh buffer for these coordinates</td>
</tr>
<tr>
<td class="address-1"><span id="7183"></span>7183</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="8">Modify the RES n,(HL) instruction at <a href="7142.html#71ae">71AE</a> below, which in effect draws a white pixel (of chalk) at the appropriate spot</td>
</tr>
<tr>
<td class="address-1"><span id="7184"></span>7184</td>
<td class="instruction">AND $07</td>
</tr>
<tr>
<td class="address-1"><span id="7186"></span>7186</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="7187"></span>7187</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="7188"></span>7188</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="7189"></span>7189</td>
<td class="instruction">CPL</td>
</tr>
<tr>
<td class="address-1"><span id="718a"></span>718A</td>
<td class="instruction">SUB $41</td>
</tr>
<tr>
<td class="address-1"><span id="718c"></span>718C</td>
<td class="instruction">LD ($71AF),A</td>
</tr>
<tr>
<td class="address-1"><span id="718f"></span>718F</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="4">Compute the pixel x-coordinate (0-63) of the rightmost pixel column of the character to be written on the board, and store it in the blackboard buffer</td>
</tr>
<tr>
<td class="address-1"><span id="7190"></span>7190</td>
<td class="instruction">ADD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="7191"></span>7191</td>
<td class="instruction">INC A</td>
</tr>
<tr>
<td class="address-1"><span id="7192"></span>7192</td>
<td class="instruction">LD (BC),A</td>
</tr>
<tr>
<td class="address-1"><span id="7193"></span>7193</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">C</span>=pixel width of the character to be written on the board</td>
</tr>
<tr>
<td class="address-1"><span id="7194"></span>7194</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL</span> at the skool UDG reference of the character square of the blackboard that will be written on and pick it up in <span class="register">L</span></td>
</tr>
<tr>
<td class="address-1"><span id="7195"></span>7195</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="7196"></span>7196</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7197"></span>
<div class="comments">
<div class="paragraph">
Now we enter the loop that draws the pixel columns of the font character bitmap onto the blackboard.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="7197"></span>7197</td>
<td class="instruction">LD H,$80</td>
<td class="comment-1" rowspan="8">Point <span class="register">HL</span> at the graphic data for the skool UDG reference in <span class="register">A</span>; the skool UDG references are 0xCE-0xBF for the Reading Room board, 0xEE-0xDF for the White Room board, and 0xDE-0xCF for the Exam Room board, decreasing from left to right</td>
</tr>
<tr>
<td class="address-1"><span id="7199"></span>7199</td>
<td class="instruction">CP $E9</td>
</tr>
<tr>
<td class="address-1"><span id="719b"></span>719B</td>
<td class="instruction">JR NC,$71A7</td>
</tr>
<tr>
<td class="address-1"><span id="719d"></span>719D</td>
<td class="instruction">CP $E7</td>
</tr>
<tr>
<td class="address-1"><span id="719f"></span>719F</td>
<td class="instruction">JR NC,$71A5</td>
</tr>
<tr>
<td class="address-1"><span id="71a1"></span>71A1</td>
<td class="instruction">CP $E1</td>
</tr>
<tr>
<td class="address-1"><span id="71a3"></span>71A3</td>
<td class="instruction">JR NC,$71A7</td>
</tr>
<tr>
<td class="address-2"><span id="71a5"></span>71A5</td>
<td class="instruction">LD H,$88</td>
</tr>
<tr>
<td class="address-2"><span id="71a7"></span>71A7</td>
<td class="instruction">INC D</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=next pixel column of the character to be written on the board</td>
</tr>
<tr>
<td class="address-1"><span id="71a8"></span>71A8</td>
<td class="instruction">LD A,(DE)</td>
</tr>
<tr>
<td class="address-1"><span id="71a9"></span>71A9</td>
<td class="instruction">LD B,$08</td>
<td class="comment-1" rowspan="1">There are 8 pixels in a pixel column</td>
</tr>
<tr>
<td class="address-2"><span id="71ab"></span>71AB</td>
<td class="instruction">RLCA</td>
<td class="comment-1" rowspan="5">Draw the pixel column on the blackboard by directly resetting bits in the skool graphic data; any bits already reset by previous writing remain reset (the 'RES n,(HL)' instruction is modified earlier in this routine to reset the required bit)</td>
</tr>
<tr>
<td class="address-1"><span id="71ac"></span>71AC</td>
<td class="instruction">JR NC,$71B0</td>
</tr>
<tr>
<td class="address-1"><span id="71ae"></span>71AE</td>
<td class="instruction">RES 7,(HL)</td>
</tr>
<tr>
<td class="address-2"><span id="71b0"></span>71B0</td>
<td class="instruction">INC H</td>
</tr>
<tr>
<td class="address-1"><span id="71b1"></span>71B1</td>
<td class="instruction">DJNZ $71AB</td>
</tr>
<tr>
<td class="address-1"><span id="71b3"></span>71B3</td>
<td class="instruction">DEC C</td>
<td class="comment-1" rowspan="1">Next pixel column</td>
</tr>
<tr>
<td class="address-1"><span id="71b4"></span>71B4</td>
<td class="instruction">JR Z,$71CE</td>
<td class="comment-1" rowspan="1">Jump if we've finished drawing the character on the board</td>
</tr>
<tr>
<td class="address-1"><span id="71b6"></span>71B6</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL</span> back at the top pixel row of the skool UDG data</td>
</tr>
<tr>
<td class="address-1"><span id="71b7"></span>71B7</td>
<td class="instruction">SUB $08</td>
</tr>
<tr>
<td class="address-1"><span id="71b9"></span>71B9</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="71ba"></span>71BA</td>
<td class="instruction">LD A,($71AF)</td>
<td class="comment-1" rowspan="5">Modify the RES n,(HL) instruction at <a href="7142.html#71ae">71AE</a> above to RES m,(HL) where m=n-1 (mod 8), effectively moving one pixel column to the right</td>
</tr>
<tr>
<td class="address-1"><span id="71bd"></span>71BD</td>
<td class="instruction">OR $40</td>
</tr>
<tr>
<td class="address-1"><span id="71bf"></span>71BF</td>
<td class="instruction">SUB $08</td>
</tr>
<tr>
<td class="address-1"><span id="71c1"></span>71C1</td>
<td class="instruction">AND $BF</td>
</tr>
<tr>
<td class="address-1"><span id="71c3"></span>71C3</td>
<td class="instruction">LD ($71AF),A</td>
</tr>
<tr>
<td class="address-1"><span id="71c6"></span>71C6</td>
<td class="instruction">CP $BE</td>
<td class="comment-1" rowspan="1">Did we wrap round from bit 0 to bit 7?</td>
</tr>
<tr>
<td class="address-1"><span id="71c8"></span>71C8</td>
<td class="instruction">JR NZ,$71A7</td>
<td class="comment-1" rowspan="1">Continue drawing pixel columns in this character square if not</td>
</tr>
<tr>
<td class="address-1"><span id="71ca"></span>71CA</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=skool UDG reference of the next character square to the right on the blackboard</td>
</tr>
<tr>
<td class="address-1"><span id="71cb"></span>71CB</td>
<td class="instruction">LD A,L</td>
</tr>
<tr>
<td class="address-1"><span id="71cc"></span>71CC</td>
<td class="instruction">JR $7197</td>
<td class="comment-1" rowspan="1">Draw the next pixel column in the next character square</td>
</tr>
<tr>
<td class="address-2"><span id="71ce"></span>71CE</td>
<td class="instruction">INC C</td>
<td class="comment-1" rowspan="1">Reset the zero flag to indicate that the message isn't finished</td>
</tr>
<tr>
<td class="address-1"><span id="71cf"></span>71CF</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="address-1"><span id="71d0"></span>71D0</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="7128.html">7128</a>
</td>
<td class="up">Up: <a href="../maps/all.html#7142">Map</a></td>
<td class="next">
Next: <a href="71D1.html">71D1</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze RAM disassembly 20210310</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd. &#169; 2021 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.4.</div>
<div><a href="../dec/asm/28994.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>