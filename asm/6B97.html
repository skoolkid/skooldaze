<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at 6B97</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Skool Daze" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="6B96.html">6B96</a>
</td>
<td class="up">Up: <a href="../maps/all.html#6b97">Map</a></td>
<td class="next">
Next: <a href="6BE5.html">6BE5</a>
</td>
</tr>
</table>
<div class="description">6B97: Check whether a chair is occupied and unseat any occupant</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="6B7D.html">6B7D</a>. Returns with the carry flag reset if the chair next to the character looking for a seat is not occupied by any of the potential occupants being checked. Otherwise knocks the occupant out of the chair and returns with the carry flag set.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">B</td>
<td class="register-desc">Number of potential occupants to check (11, 3, or 1)</td>
</tr>
<tr>
<td class="register">D</td>
<td class="register-desc">Number of the first potential occupant to check (0x98, 0xA7, or 0xAC)</td>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Number of the character looking for a seat (0x98-0xA9)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="6b97"></span>6B97</td>
<td class="instruction">LD L,$62</td>
<td class="comment-1" rowspan="2">Byte 0x62 of a character's buffer holds his x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="6b99"></span>6B99</td>
<td class="instruction">LD E,L</td>
</tr>
<tr>
<td class="address-1"><span id="6b9a"></span>6B9A</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=x-coordinate of the potential dethronee</td>
</tr>
<tr>
<td class="address-1"><span id="6b9b"></span>6B9B</td>
<td class="instruction">CP (HL)</td>
<td class="comment-1" rowspan="1">Do the x-coordinates match?</td>
</tr>
<tr>
<td class="address-1"><span id="6b9c"></span>6B9C</td>
<td class="instruction">JR NZ,$6BAC</td>
<td class="comment-1" rowspan="1">Jump ahead to consider the next character if not</td>
</tr>
<tr>
<td class="address-1"><span id="6b9e"></span>6B9E</td>
<td class="instruction">DEC E</td>
<td class="comment-1" rowspan="2"><span class="register">E</span>=<span class="register">L</span>=0x61 (which byte holds the character's y-coordinate)</td>
</tr>
<tr>
<td class="address-1"><span id="6b9f"></span>6B9F</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="address-1"><span id="6ba0"></span>6BA0</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=y-coordinate of the potential dethronee</td>
</tr>
<tr>
<td class="address-1"><span id="6ba1"></span>6BA1</td>
<td class="instruction">CP (HL)</td>
<td class="comment-1" rowspan="1">Do the y-coordinates match?</td>
</tr>
<tr>
<td class="address-1"><span id="6ba2"></span>6BA2</td>
<td class="instruction">JR NZ,$6BAC</td>
<td class="comment-1" rowspan="1">Jump ahead to consider the next character if not</td>
</tr>
<tr>
<td class="address-1"><span id="6ba4"></span>6BA4</td>
<td class="instruction">DEC E</td>
<td class="comment-1" rowspan="1"><span class="register">E</span>=0x60</td>
</tr>
<tr>
<td class="address-1"><span id="6ba5"></span>6BA5</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=animatory state of the potential dethronee</td>
</tr>
<tr>
<td class="address-1"><span id="6ba6"></span>6BA6</td>
<td class="instruction">AND $0F</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="6ba8"></span>6BA8</td>
<td class="instruction">CP $05</td>
<td class="comment-1" rowspan="1">Is this character sitting in the chair?</td>
</tr>
<tr>
<td class="address-1"><span id="6baa"></span>6BAA</td>
<td class="instruction">JR Z,$6BB1</td>
<td class="comment-1" rowspan="1">Dethrone him if so</td>
</tr>
<tr>
<td class="address-2"><span id="6bac"></span>6BAC</td>
<td class="instruction">INC D</td>
<td class="comment-1" rowspan="1">Next character to check</td>
</tr>
<tr>
<td class="address-1"><span id="6bad"></span>6BAD</td>
<td class="instruction">DJNZ $6B97</td>
<td class="comment-1" rowspan="1">Jump back until all potential dethronees have been checked</td>
</tr>
<tr>
<td class="address-1"><span id="6baf"></span>6BAF</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="2">Return with the carry flag reset to indicate that no one was knocked out of the chair</td>
</tr>
<tr>
<td class="address-1"><span id="6bb0"></span>6BB0</td>
<td class="instruction">RET</td>
</tr>
<tr>
<td class="address-2"><span id="6bb1"></span>6BB1</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=number of the character sitting in the chair</td>
</tr>
<tr>
<td class="address-1"><span id="6bb2"></span>6BB2</td>
<td class="instruction">CP $AC</td>
<td class="comment-1" rowspan="1">Is ERIC sitting here?</td>
</tr>
<tr>
<td class="address-1"><span id="6bb4"></span>6BB4</td>
<td class="instruction">JR NZ,$6BD1</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="6bb6"></span>6BB6</td>
<td class="instruction">LD DE,$7FFB</td>
<td class="comment-1" rowspan="1"><a href="7FFB.html">7FFB</a> holds ERIC's status flags</td>
</tr>
<tr>
<td class="address-1"><span id="6bb9"></span>6BB9</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="6bba"></span>6BBA</td>
<td class="instruction">SET 4,(HL)</td>
<td class="comment-1" rowspan="1">Signal: ERIC has been knocked out of his chair</td>
</tr>
<tr>
<td class="address-2"><span id="6bbc"></span>6BBC</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="6bbd"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="6B7D.html">6B7D</a> to make the chair-seeking character sit down after having found a vacant seat.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="6bbd"></span>6BBD</td>
<td class="instruction">LD L,$70</td>
<td class="comment-1" rowspan="2">Remove the uninterruptible subcommand routine address from bytes 0x6F and 0x70 of the buffer of the character who is going to sit down</td>
</tr>
<tr>
<td class="address-1"><span id="6bbf"></span>6BBF</td>
<td class="instruction">LD (HL),$00</td>
</tr>
<tr>
<td class="address-1"><span id="6bc1"></span>6BC1</td>
<td class="instruction">LD L,$60</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=this character's current animatory state</td>
</tr>
<tr>
<td class="address-1"><span id="6bc3"></span>6BC3</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="6bc4"></span>6BC4</td>
<td class="instruction">AND $F8</td>
<td class="comment-1" rowspan="2">Set <span class="register">A</span> to the animatory state of this character sitting in a chair</td>
</tr>
<tr>
<td class="address-1"><span id="6bc6"></span>6BC6</td>
<td class="instruction">ADD A,$05</td>
</tr>
<tr>
<td class="address-2"><span id="6bc8"></span>6BC8</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="4">Pick up the character's coordinates in <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="6bc9"></span>6BC9</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="6bca"></span>6BCA</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="6bcb"></span>6BCB</td>
<td class="instruction">LD E,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="6bcc"></span>6BCC</td>
<td class="instruction">CALL <a href="61B0.html">$61B0</a></td>
<td class="comment-1" rowspan="1">Update the character's animatory state and update the SRB</td>
</tr>
<tr>
<td class="address-1"><span id="6bcf"></span>6BCF</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="2">Return with the carry flag set to indicate that a character was pushed out of his chair</td>
</tr>
<tr>
<td class="address-1"><span id="6bd0"></span>6BD0</td>
<td class="instruction">RET</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="6bd1"></span>
<div class="comments">
<div class="paragraph">
Someone is sitting in the chair, but it isn't ERIC.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="6bd1"></span>6BD1</td>
<td class="instruction">LD E,$70</td>
<td class="comment-1" rowspan="3">Is there an uninterruptible subcommand routine address in bytes 0x6F and 0x70 of the seated character's buffer?</td>
</tr>
<tr>
<td class="address-1"><span id="6bd3"></span>6BD3</td>
<td class="instruction">LD A,(DE)</td>
</tr>
<tr>
<td class="address-1"><span id="6bd4"></span>6BD4</td>
<td class="instruction">AND A</td>
</tr>
<tr>
<td class="address-1"><span id="6bd5"></span>6BD5</td>
<td class="instruction">JR Z,$6BDD</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="6bd7"></span>
<div class="comments">
<div class="paragraph">
The current occupant of the chair must be in the process of being dethroned by someone else at the moment (i.e. bytes 0x6F and 0x70 of his buffer hold the address of the uninterruptible subcommand routine at <a href="6C55.html">6C55</a>). In that case, the chair-seeking character will give way to the dethroner and look for another chair.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="6bd7"></span>6BD7</td>
<td class="instruction">LD L,$60</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=current animatory state of the character who wants to sit down</td>
</tr>
<tr>
<td class="address-1"><span id="6bd9"></span>6BD9</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="6bda"></span>6BDA</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="2">Put this character midstride; this has the effect of making him walk to the next chair</td>
</tr>
<tr>
<td class="address-1"><span id="6bdb"></span>6BDB</td>
<td class="instruction">JR $6BC8</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="6bdd"></span>
<div class="comments">
<div class="paragraph">
The current occupant of the chair can be dethroned. Make it so.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="6bdd"></span>6BDD</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="6bde"></span>6BDE</td>
<td class="instruction">LD (HL),$6C</td>
<td class="comment-1" rowspan="3">Place the address of the uninterruptible subcommand routine at <a href="6C55.html">6C55</a> into bytes 0x6F and 0x70 of the seated character's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="6be0"></span>6BE0</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="address-1"><span id="6be1"></span>6BE1</td>
<td class="instruction">LD (HL),$55</td>
</tr>
<tr>
<td class="address-1"><span id="6be3"></span>6BE3</td>
<td class="instruction">JR $6BBC</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="6B96.html">6B96</a>
</td>
<td class="up">Up: <a href="../maps/all.html#6b97">Map</a></td>
<td class="next">
Next: <a href="6BE5.html">6BE5</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze RAM disassembly 20200809</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../dec/asm/27543.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>