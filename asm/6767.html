<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at 6767</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Skool Daze" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="6752.html">6752</a>
</td>
<td class="up">Up: <a href="../maps/all.html#6767">Map</a></td>
<td class="next">
Next: <a href="67CC.html">67CC</a>
</td>
</tr>
</table>
<div class="description">6767: Main loop</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Entered from the routine at <a href="F918.html">F918</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="6767"></span>6767</td>
<td class="instruction">LD HL,($7FF7)</td>
<td class="comment-1" rowspan="1"><a href="7FF7.html">7FF7</a> holds the lesson clock</td>
</tr>
<tr>
<td class="address-1"><span id="676a"></span>676A</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="4">Decrease it by 1 and set the zero flag if it's time to ring the bell</td>
</tr>
<tr>
<td class="address-1"><span id="676b"></span>676B</td>
<td class="instruction">LD A,H</td>
</tr>
<tr>
<td class="address-1"><span id="676c"></span>676C</td>
<td class="instruction">OR L</td>
</tr>
<tr>
<td class="address-1"><span id="676d"></span>676D</td>
<td class="instruction">LD ($7FF7),HL</td>
</tr>
<tr>
<td class="address-1"><span id="6770"></span>6770</td>
<td class="instruction">CALL Z,<a href="66E6.html">$66E6</a></td>
<td class="comment-1" rowspan="1">Change the lesson if the lesson clock reached zero</td>
</tr>
<tr>
<td class="address-1"><span id="6773"></span>6773</td>
<td class="instruction">CALL <a href="6226.html">$6226</a></td>
<td class="comment-1" rowspan="1">Move the characters</td>
</tr>
<tr>
<td class="address-1"><span id="6776"></span>6776</td>
<td class="instruction">CALL <a href="6AD9.html">$6AD9</a></td>
<td class="comment-1" rowspan="1">Move ERIC</td>
</tr>
<tr>
<td class="address-1"><span id="6779"></span>6779</td>
<td class="instruction">JR C,$67BC</td>
<td class="comment-1" rowspan="1">Jump if ERIC has already been dealt with</td>
</tr>
<tr>
<td class="address-1"><span id="677b"></span>677B</td>
<td class="instruction">LD HL,$7FE8</td>
<td class="comment-1" rowspan="2">Decrement ERIC's main action timer at <a href="7FE8.html">7FE8</a></td>
</tr>
<tr>
<td class="address-1"><span id="677e"></span>677E</td>
<td class="instruction">DEC (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="677f"></span>677F</td>
<td class="instruction">JR NZ,$67BC</td>
<td class="comment-1" rowspan="1">Jump unless it's time to deal with ERIC</td>
</tr>
<tr>
<td class="address-1"><span id="6781"></span>6781</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="2">Pick up the midstride indicator at <a href="7FE9.html">7FE9</a></td>
</tr>
<tr>
<td class="address-1"><span id="6782"></span>6782</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="6783"></span>6783</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is ERIC midstride?</td>
</tr>
<tr>
<td class="address-1"><span id="6784"></span>6784</td>
<td class="instruction">JR Z,$678B</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="6786"></span>6786</td>
<td class="instruction">CALL <a href="6500.html">$6500</a></td>
<td class="comment-1" rowspan="1">Move ERIC from the midstride position, then scroll the screen left or right if necessary</td>
</tr>
<tr>
<td class="address-1"><span id="6789"></span>6789</td>
<td class="instruction">JR $67BF</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="678b"></span>
<div class="comments">
<div class="paragraph">
Time to check the keyboard (or simulate a keypress in demo mode) to see how ERIC should move next.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="678b"></span>678B</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="2">Reset ERIC's main action timer at <a href="7FE8.html">7FE8</a> to 9</td>
</tr>
<tr>
<td class="address-1"><span id="678c"></span>678C</td>
<td class="instruction">LD (HL),$09</td>
</tr>
<tr>
<td class="address-1"><span id="678e"></span>678E</td>
<td class="instruction">CALL <a href="F5DA.html">$F5DA</a></td>
<td class="comment-1" rowspan="1">Collect or simulate a keypress</td>
</tr>
<tr>
<td class="address-1"><span id="6791"></span>6791</td>
<td class="instruction">JR Z,$67BC</td>
<td class="comment-1" rowspan="1">Jump if no relevant keypress was collected or simulated</td>
</tr>
<tr>
<td class="address-1"><span id="6793"></span>6793</td>
<td class="instruction">LD HL,$7FFB</td>
<td class="comment-1" rowspan="1"><a href="7FFB.html">7FFB</a> holds ERIC's status flags</td>
</tr>
<tr>
<td class="address-1"><span id="6796"></span>6796</td>
<td class="instruction">BIT 5,(HL)</td>
<td class="comment-1" rowspan="1">Is ERIC writing on a blackboard?</td>
</tr>
<tr>
<td class="address-1"><span id="6798"></span>6798</td>
<td class="instruction">JR Z,$679F</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="679a"></span>679A</td>
<td class="instruction">CALL <a href="F6AA.html">$F6AA</a></td>
<td class="comment-1" rowspan="1">Deal with keypresses while ERIC is writing on the board</td>
</tr>
<tr>
<td class="address-1"><span id="679d"></span>679D</td>
<td class="instruction">JR $67BC</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="679f"></span>679F</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="2"><span class="register">DE</span>=<a href="7FFC.html">7FFC</a> (which holds the ASCII code of the last keypress)</td>
</tr>
<tr>
<td class="address-1"><span id="67a0"></span>67A0</td>
<td class="instruction">EX DE,HL</td>
</tr>
<tr>
<td class="address-1"><span id="67a1"></span>67A1</td>
<td class="instruction">CP $20</td>
<td class="comment-1" rowspan="1">Was the keypress ASCII code &gt;= 0x20?</td>
</tr>
<tr>
<td class="address-1"><span id="67a3"></span>67A3</td>
<td class="instruction">JR C,$67BC</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="67a5"></span>67A5</td>
<td class="instruction">LD HL,$67BC</td>
<td class="comment-1" rowspan="2">Push the address of the entry point at <a href="6767.html#67bc">67BC</a> (see below) onto the stack</td>
</tr>
<tr>
<td class="address-1"><span id="67a8"></span>67A8</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="address-1"><span id="67a9"></span>67A9</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL</span> at the appropriate entry in the <a href="6820.html">keypress offset table</a></td>
</tr>
<tr>
<td class="address-1"><span id="67aa"></span>67AA</td>
<td class="instruction">LD H,$68</td>
</tr>
<tr>
<td class="address-1"><span id="67ac"></span>67AC</td>
<td class="instruction">LD L,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="67ad"></span>67AD</td>
<td class="instruction">LDI</td>
<td class="comment-1" rowspan="1">Copy the ASCII code of the keypress into <a href="7FFC.html">7FFC</a></td>
</tr>
<tr>
<td class="address-1"><span id="67af"></span>67AF</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-1" rowspan="3">Pick up in <span class="register">DE</span> the address of the appropriate routine for dealing with the keypress</td>
</tr>
<tr>
<td class="address-1"><span id="67b0"></span>67B0</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="67b1"></span>67B1</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="67b2"></span>67B2</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Push this address onto the stack</td>
</tr>
<tr>
<td class="address-1"><span id="67b3"></span>67B3</td>
<td class="instruction">LD HL,$AC60</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 0x60 of ERIC's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="67b6"></span>67B6</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-1" rowspan="5">Pick up ERIC's animatory state in <span class="register">B</span> and his coordinates in <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="67b7"></span>67B7</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="67b8"></span>67B8</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="67b9"></span>67B9</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="67ba"></span>67BA</td>
<td class="instruction">LD E,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="67bb"></span>67BB</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Make an indirect jump to the appropriate routine for dealing with ERIC, then return to <a href="6767.html#67bc">67BC</a> below</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="67bc"></span>
<div class="comments">
<div class="paragraph">
Now that ERIC has been moved or otherwise dealt with, update the display.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="67bc"></span>67BC</td>
<td class="instruction">CALL <a href="6992.html">$6992</a></td>
<td class="comment-1" rowspan="1">Update the display</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="67bf"></span>
<div class="comments">
<div class="paragraph">
The next section of code ensures that we don't pass through the main loop more than once every 20 milliseconds.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="67bf"></span>67BF</td>
<td class="instruction">LD HL,$7FFA</td>
<td class="comment-1" rowspan="5">Wait until the system variable FRAMES at 5C78 has been incremented since the last time it was checked (FRAMES is incremented every 20ms)</td>
</tr>
<tr>
<td class="address-2"><span id="67c2"></span>67C2</td>
<td class="instruction">LD A,($5C78)</td>
</tr>
<tr>
<td class="address-1"><span id="67c5"></span>67C5</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="67c6"></span>67C6</td>
<td class="instruction">JR Z,$67C2</td>
</tr>
<tr>
<td class="address-1"><span id="67c8"></span>67C8</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="67c9"></span>67C9</td>
<td class="instruction">JP $6767</td>
<td class="comment-1" rowspan="1">Jump back to the beginning of the main loop</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="6752.html">6752</a>
</td>
<td class="up">Up: <a href="../maps/all.html#6767">Map</a></td>
<td class="next">
Next: <a href="67CC.html">67CC</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze RAM disassembly 20221122</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../dec/asm/26471.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>