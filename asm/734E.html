<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at 734E</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Skool Daze" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="7349.html">7349</a>
</td>
<td class="up">Up: <a href="../maps/all.html#734e">Map</a></td>
<td class="next">
Next: <a href="7400.html">7400</a>
</td>
</tr>
</table>
<div class="description">734E: Print the speech bubble</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="7986.html">7986</a>. Returns with the carry flag set if the character about to speak is off-screen. Returns with the zero flag reset if somebody else is speaking at the moment.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Number of the character about to speak (0x98-0xA9)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="734e"></span>734E</td>
<td class="instruction">LD A,($7F00)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=leftmost column of the skool on screen (0-64)</td>
</tr>
<tr>
<td class="address-1"><span id="7351"></span>7351</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="7352"></span>7352</td>
<td class="instruction">LD L,$62</td>
<td class="comment-1" rowspan="1">Byte 0x62 of a character's buffer holds his x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="7354"></span>7354</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick this up in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="7355"></span>7355</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="4">Return with the carry flag set if the character is off-screen to the left</td>
</tr>
<tr>
<td class="address-1"><span id="7356"></span>7356</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="7357"></span>7357</td>
<td class="instruction">SUB B</td>
</tr>
<tr>
<td class="address-1"><span id="7358"></span>7358</td>
<td class="instruction">RET C</td>
</tr>
<tr>
<td class="address-1"><span id="7359"></span>7359</td>
<td class="instruction">CP $20</td>
<td class="comment-1" rowspan="3">Return with the carry flag set if the character is off-screen to the right</td>
</tr>
<tr>
<td class="address-1"><span id="735b"></span>735B</td>
<td class="instruction">CCF</td>
</tr>
<tr>
<td class="address-1"><span id="735c"></span>735C</td>
<td class="instruction">RET C</td>
</tr>
<tr>
<td class="address-1"><span id="735d"></span>735D</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1"><span class="register">C</span>=screen x-coordinate (0-31) of the spot above the character's head (where the speech bubble lip will be)</td>
</tr>
<tr>
<td class="address-1"><span id="735e"></span>735E</td>
<td class="instruction">LD A,($7F65)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=current speech bubble lip x-coordinate (if any)</td>
</tr>
<tr>
<td class="address-1"><span id="7361"></span>7361</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is somebody else speaking at the moment?</td>
</tr>
<tr>
<td class="address-1"><span id="7362"></span>7362</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return with the zero flag reset if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7363"></span>
<div class="comments">
<div class="paragraph">
The character is on-screen and no one else is speaking at the moment.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="7363"></span>7363</td>
<td class="instruction">LD L,$60</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="7365"></span>7365</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=character number (0x98-0xA9)</td>
</tr>
<tr>
<td class="address-1"><span id="7366"></span>7366</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=0x61</td>
</tr>
<tr>
<td class="address-1"><span id="7367"></span>7367</td>
<td class="instruction">CP $A7</td>
<td class="comment-1" rowspan="1">Set the carry flag unless EINSTEIN is the speaker</td>
</tr>
<tr>
<td class="address-1"><span id="7369"></span>7369</td>
<td class="instruction">SBC A,A</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=0x00 if EINSTEIN is speaking, 0xFF otherwise</td>
</tr>
<tr>
<td class="address-1"><span id="736a"></span>736A</td>
<td class="instruction">ADD A,(HL)</td>
<td class="comment-1" rowspan="2"><span class="register">D</span>=y if EINSTEIN is speaking, y-1 otherwise (where y is the speaker's y-coordinate)</td>
</tr>
<tr>
<td class="address-1"><span id="736b"></span>736B</td>
<td class="instruction">LD D,A</td>
</tr>
<tr>
<td class="address-1"><span id="736c"></span>736C</td>
<td class="instruction">LD ($7F64),DE</td>
<td class="comment-1" rowspan="1">Store the speech bubble lip coordinates at <a href="7F64.html">7F64</a></td>
</tr>
<tr>
<td class="address-1"><span id="7370"></span>7370</td>
<td class="instruction">SUB $98</td>
<td class="comment-1" rowspan="12">Get the attribute file address of the speech bubble lip in <span class="register">BC</span></td>
</tr>
<tr>
<td class="address-1"><span id="7372"></span>7372</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="7373"></span>7373</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="7374"></span>7374</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="7375"></span>7375</td>
<td class="instruction">LD B,A</td>
</tr>
<tr>
<td class="address-1"><span id="7376"></span>7376</td>
<td class="instruction">AND $E0</td>
</tr>
<tr>
<td class="address-1"><span id="7378"></span>7378</td>
<td class="instruction">ADD A,C</td>
</tr>
<tr>
<td class="address-1"><span id="7379"></span>7379</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="address-1"><span id="737a"></span>737A</td>
<td class="instruction">LD A,B</td>
</tr>
<tr>
<td class="address-1"><span id="737b"></span>737B</td>
<td class="instruction">AND $03</td>
</tr>
<tr>
<td class="address-1"><span id="737d"></span>737D</td>
<td class="instruction">ADD A,$58</td>
</tr>
<tr>
<td class="address-1"><span id="737f"></span>737F</td>
<td class="instruction">LD B,A</td>
</tr>
<tr>
<td class="address-1"><span id="7380"></span>7380</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=UDG reference of the character square under the speech bubble lip</td>
</tr>
<tr>
<td class="address-1"><span id="7381"></span>7381</td>
<td class="instruction">LD ($7F66),A</td>
<td class="comment-1" rowspan="1">Store this in <a href="7F66.html">7F66</a></td>
</tr>
<tr>
<td class="address-1"><span id="7384"></span>7384</td>
<td class="instruction">LD A,$EF</td>
<td class="comment-1" rowspan="1">0xEF=UDG reference for the speech bubble lip</td>
</tr>
<tr>
<td class="address-1"><span id="7386"></span>7386</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-1" rowspan="1">Replace the skool UDG with the speech bubble lip UDG</td>
</tr>
<tr>
<td class="address-1"><span id="7387"></span>7387</td>
<td class="instruction">SET 7,E</td>
<td class="comment-1" rowspan="3">Pick up the skool attribute byte of the character square under the speech bubble lip and store it in <a href="7F66.html#7f67">7F67</a></td>
</tr>
<tr>
<td class="address-1"><span id="7389"></span>7389</td>
<td class="instruction">LD A,(DE)</td>
</tr>
<tr>
<td class="address-1"><span id="738a"></span>738A</td>
<td class="instruction">LD ($7F67),A</td>
</tr>
<tr>
<td class="address-1"><span id="738d"></span>738D</td>
<td class="instruction">LD A,$38</td>
<td class="comment-1" rowspan="1">0x38=PAPER 7: INK 0</td>
</tr>
<tr>
<td class="address-1"><span id="738f"></span>738F</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-1" rowspan="1">Replace the skool attribute byte</td>
</tr>
<tr>
<td class="address-1"><span id="7390"></span>7390</td>
<td class="instruction">LD (BC),A</td>
<td class="comment-1" rowspan="1">Set the new attribute on-screen</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7391"></span>
<div class="comments">
<div class="paragraph">
The skool UDG reference and attribute byte for the location of the speech bubble lip have been adjusted. Now for the speech bubble itself.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="7391"></span>7391</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="3">Get the x-coordinate of the left edge of the speech bubble in <span class="register">E</span></td>
</tr>
<tr>
<td class="address-1"><span id="7392"></span>7392</td>
<td class="instruction">AND $78</td>
</tr>
<tr>
<td class="address-1"><span id="7394"></span>7394</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="7395"></span>7395</td>
<td class="instruction">DEC D</td>
<td class="comment-1" rowspan="2">The speech bubble is two character squares high</td>
</tr>
<tr>
<td class="address-1"><span id="7396"></span>7396</td>
<td class="instruction">DEC D</td>
</tr>
<tr>
<td class="address-1"><span id="7397"></span>7397</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="7398"></span>7398</td>
<td class="instruction">LD HL,$FFC0</td>
<td class="comment-1" rowspan="5">Set <span class="register">HL</span> to the attribute file address for the top-left corner of the speech bubble</td>
</tr>
<tr>
<td class="address-1"><span id="739b"></span>739B</td>
<td class="instruction">ADD HL,BC</td>
</tr>
<tr>
<td class="address-1"><span id="739c"></span>739C</td>
<td class="instruction">LD A,L</td>
</tr>
<tr>
<td class="address-1"><span id="739d"></span>739D</td>
<td class="instruction">AND $F8</td>
</tr>
<tr>
<td class="address-1"><span id="739f"></span>739F</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="73a0"></span>73A0</td>
<td class="instruction">LD B,$08</td>
<td class="comment-1" rowspan="4">Fill in the top row of 8 character squares with the speech bubble attribute (0x38=PAPER 7: INK 0)</td>
</tr>
<tr>
<td class="address-2"><span id="73a2"></span>73A2</td>
<td class="instruction">LD (HL),$38</td>
</tr>
<tr>
<td class="address-1"><span id="73a4"></span>73A4</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address-1"><span id="73a5"></span>73A5</td>
<td class="instruction">DJNZ $73A2</td>
</tr>
<tr>
<td class="address-1"><span id="73a7"></span>73A7</td>
<td class="instruction">LD C,$18</td>
<td class="comment-1" rowspan="2">Set <span class="register">HL</span> to the attribute file address for the bottom-left corner of the speech bubble</td>
</tr>
<tr>
<td class="address-1"><span id="73a9"></span>73A9</td>
<td class="instruction">ADD HL,BC</td>
</tr>
<tr>
<td class="address-1"><span id="73aa"></span>73AA</td>
<td class="instruction">LD B,$08</td>
<td class="comment-1" rowspan="4">Fill in the bottom row of 8 character squares with the speech bubble attribute (0x38=PAPER 7: INK 0)</td>
</tr>
<tr>
<td class="address-2"><span id="73ac"></span>73AC</td>
<td class="instruction">LD (HL),$38</td>
</tr>
<tr>
<td class="address-1"><span id="73ae"></span>73AE</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="73af"></span>73AF</td>
<td class="instruction">DJNZ $73AC</td>
</tr>
<tr>
<td class="address-1"><span id="73b1"></span>73B1</td>
<td class="instruction">LD HL,$7F68</td>
<td class="comment-1" rowspan="5">Store the UDG references for the part of the skool that will be overwritten by the top row of the speech bubble at <a href="7F66.html#7f68">7F68</a></td>
</tr>
<tr>
<td class="address-1"><span id="73b4"></span>73B4</td>
<td class="instruction">EX DE,HL</td>
</tr>
<tr>
<td class="address-1"><span id="73b5"></span>73B5</td>
<td class="instruction">LD A,L</td>
</tr>
<tr>
<td class="address-1"><span id="73b6"></span>73B6</td>
<td class="instruction">LD C,$08</td>
</tr>
<tr>
<td class="address-1"><span id="73b8"></span>73B8</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="73ba"></span>73BA</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="6">Replace the 8 UDG references for the part of the skool that will be overwritten by the top row of the speech bubble with the appropriate speech bubble UDG references (0xF0-0xF7)</td>
</tr>
<tr>
<td class="address-1"><span id="73bb"></span>73BB</td>
<td class="instruction">LD BC,$08F0</td>
</tr>
<tr>
<td class="address-2"><span id="73be"></span>73BE</td>
<td class="instruction">LD (HL),C</td>
</tr>
<tr>
<td class="address-1"><span id="73bf"></span>73BF</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="73c0"></span>73C0</td>
<td class="instruction">INC C</td>
</tr>
<tr>
<td class="address-1"><span id="73c1"></span>73C1</td>
<td class="instruction">DJNZ $73BE</td>
</tr>
<tr>
<td class="address-1"><span id="73c3"></span>73C3</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="4">Store the UDG references for the part of the skool that will be overwritten by the bottom row of the speech bubble at <a href="7F66.html#7f70">7F70</a></td>
</tr>
<tr>
<td class="address-1"><span id="73c4"></span>73C4</td>
<td class="instruction">INC H</td>
</tr>
<tr>
<td class="address-1"><span id="73c5"></span>73C5</td>
<td class="instruction">LD C,$08</td>
</tr>
<tr>
<td class="address-1"><span id="73c7"></span>73C7</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="73c9"></span>73C9</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="6">Replace the 8 UDG references for the part of the skool that will be overwritten by the bottom row of the speech bubble with the appropriate speech bubble UDG references (0xF8-0xFF)</td>
</tr>
<tr>
<td class="address-1"><span id="73ca"></span>73CA</td>
<td class="instruction">LD BC,$08F8</td>
</tr>
<tr>
<td class="address-2"><span id="73cd"></span>73CD</td>
<td class="instruction">LD (HL),C</td>
</tr>
<tr>
<td class="address-1"><span id="73ce"></span>73CE</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="73cf"></span>73CF</td>
<td class="instruction">INC C</td>
</tr>
<tr>
<td class="address-1"><span id="73d0"></span>73D0</td>
<td class="instruction">DJNZ $73CD</td>
</tr>
<tr>
<td class="address-1"><span id="73d2"></span>73D2</td>
<td class="instruction">ADD A,$80</td>
<td class="comment-1" rowspan="5">Store the 8 attribute bytes for the part of the skool that will be overwritten by the top row of the speech bubble at <a href="7F66.html#7f78">7F78</a></td>
</tr>
<tr>
<td class="address-1"><span id="73d4"></span>73D4</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="73d5"></span>73D5</td>
<td class="instruction">LD C,$08</td>
</tr>
<tr>
<td class="address-1"><span id="73d7"></span>73D7</td>
<td class="instruction">DEC H</td>
</tr>
<tr>
<td class="address-1"><span id="73d8"></span>73D8</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="73da"></span>73DA</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="5">Replace the 8 attribute bytes for the part of the skool that will be overwritten by the top row of the speech bubble with the appropriate speech bubble attribute byte (<span class="register">C</span>=0x38=PAPER 7: INK 0)</td>
</tr>
<tr>
<td class="address-1"><span id="73db"></span>73DB</td>
<td class="instruction">LD BC,$0838</td>
</tr>
<tr>
<td class="address-2"><span id="73de"></span>73DE</td>
<td class="instruction">LD (HL),C</td>
</tr>
<tr>
<td class="address-1"><span id="73df"></span>73DF</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="73e0"></span>73E0</td>
<td class="instruction">DJNZ $73DE</td>
</tr>
<tr>
<td class="address-1"><span id="73e2"></span>73E2</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="4">Store the 8 attribute bytes for the part of the skool that will be overwritten by the bottom row of the speech bubble at <a href="7F66.html#7f80">7F80</a></td>
</tr>
<tr>
<td class="address-1"><span id="73e3"></span>73E3</td>
<td class="instruction">LD C,$08</td>
</tr>
<tr>
<td class="address-1"><span id="73e5"></span>73E5</td>
<td class="instruction">INC H</td>
</tr>
<tr>
<td class="address-1"><span id="73e6"></span>73E6</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="73e8"></span>73E8</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="5">Replace the 8 attribute bytes for the part of the skool that will be overwritten by the bottom row of the speech bubble with the appropriate speech bubble attribute byte (<span class="register">C</span>=0x38=PAPER 7: INK 0)</td>
</tr>
<tr>
<td class="address-1"><span id="73e9"></span>73E9</td>
<td class="instruction">LD BC,$0838</td>
</tr>
<tr>
<td class="address-2"><span id="73ec"></span>73EC</td>
<td class="instruction">LD (HL),C</td>
</tr>
<tr>
<td class="address-1"><span id="73ed"></span>73ED</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="73ee"></span>73EE</td>
<td class="instruction">DJNZ $73EC</td>
</tr>
<tr>
<td class="address-1"><span id="73f0"></span>73F0</td>
<td class="instruction">LD DE,($7F64)</td>
<td class="comment-1" rowspan="1">Copy the speech bubble lip coordinates from <a href="7F64.html">7F64</a> to <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="73f4"></span>73F4</td>
<td class="instruction">CALL <a href="7087.html">$7087</a></td>
<td class="comment-1" rowspan="1">Update the SRB for the lip of speech bubble</td>
</tr>
<tr>
<td class="address-1"><span id="73f7"></span>73F7</td>
<td class="instruction">CALL <a href="F4FA.html">$F4FA</a></td>
<td class="comment-1" rowspan="1">Open the lip of the speech bubble</td>
</tr>
<tr>
<td class="address-1"><span id="73fa"></span>73FA</td>
<td class="instruction">CALL <a href="7427.html">$7427</a></td>
<td class="comment-1" rowspan="1">Update the SRB for the speech bubble</td>
</tr>
<tr>
<td class="address-1"><span id="73fd"></span>73FD</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="73fe"></span>73FE</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1">Set the zero flag</td>
</tr>
<tr>
<td class="address-1"><span id="73ff"></span>73FF</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return with the zero flag set to indicate success</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="7349.html">7349</a>
</td>
<td class="up">Up: <a href="../maps/all.html#734e">Map</a></td>
<td class="next">
Next: <a href="7400.html">7400</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze RAM disassembly 20200809</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../dec/asm/29518.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>