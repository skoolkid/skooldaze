<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at 7E17</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Skool Daze" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="7E07.html">7E07</a>
</td>
<td class="up">Up: <a href="../maps/all.html#7e17">Map</a></td>
<td class="next">
Next: <a href="7E61.html">7E61</a>
</td>
</tr>
</table>
<div class="description">7E17: Play a tune</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="7E86.html">7E86</a>, <a href="7E90.html">7E90</a>, <a href="7E96.html">7E96</a> and <a href="7EA2.html">7EA2</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">Base address of the tune data table</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="7e17"></span>7E17</td>
<td class="instruction">DI</td>
<td class="comment-1" rowspan="1">Disable interrupts</td>
</tr>
<tr>
<td class="address-2"><span id="7e18"></span>7E18</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Pick up a tune datum in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="7e19"></span>7E19</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the next tune datum</td>
</tr>
<tr>
<td class="address-1"><span id="7e1a"></span>7E1A</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is the tune finished?</td>
</tr>
<tr>
<td class="address-1"><span id="7e1b"></span>7E1B</td>
<td class="instruction">JR NZ,$7E22</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="7e1d"></span>7E1D</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="2">Make the border blue</td>
</tr>
<tr>
<td class="address-1"><span id="7e1e"></span>7E1E</td>
<td class="instruction">OUT ($FE),A</td>
</tr>
<tr>
<td class="address-1"><span id="7e20"></span>7E20</td>
<td class="instruction">EI</td>
<td class="comment-1" rowspan="1">Re-enable interrupts</td>
</tr>
<tr>
<td class="address-1"><span id="7e21"></span>7E21</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7e22"></span>
<div class="comments">
<div class="paragraph">
A non-zero tune datum has been found, meaning the tune is not finished yet.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="7e22"></span>7E22</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="7e23"></span>7E23</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Copy the tune datum to <span class="register">B</span></td>
</tr>
<tr>
<td class="address-1"><span id="7e24"></span>7E24</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="1">Should we pause briefly (bit 0 set) here?</td>
</tr>
<tr>
<td class="address-1"><span id="7e25"></span>7E25</td>
<td class="instruction">JR NC,$7E30</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="7e27"></span>7E27</td>
<td class="instruction">LD DE,$0F00</td>
<td class="comment-1" rowspan="5">Pause briefly (this happens for all but one note in the theme tune, and for all notes in the 'all shields/safe' tune)</td>
</tr>
<tr>
<td class="address-2"><span id="7e2a"></span>7E2A</td>
<td class="instruction">DEC E</td>
</tr>
<tr>
<td class="address-1"><span id="7e2b"></span>7E2B</td>
<td class="instruction">JR NZ,$7E2A</td>
</tr>
<tr>
<td class="address-1"><span id="7e2d"></span>7E2D</td>
<td class="instruction">DEC D</td>
</tr>
<tr>
<td class="address-1"><span id="7e2e"></span>7E2E</td>
<td class="instruction">JR NZ,$7E2A</td>
</tr>
<tr>
<td class="address-2"><span id="7e30"></span>7E30</td>
<td class="instruction">AND $07</td>
<td class="comment-1" rowspan="1">0&lt;=<span class="register">A</span>&lt;=7</td>
</tr>
<tr>
<td class="address-1"><span id="7e32"></span>7E32</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1"><span class="register">C</span>=border colour for this note</td>
</tr>
<tr>
<td class="address-1"><span id="7e33"></span>7E33</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="4">Point <span class="register">HL</span> at the appropriate entry in the note pitch/duration data table at <a href="7E07.html">7E07</a></td>
</tr>
<tr>
<td class="address-1"><span id="7e34"></span>7E34</td>
<td class="instruction">ADD A,$07</td>
</tr>
<tr>
<td class="address-1"><span id="7e36"></span>7E36</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="7e37"></span>7E37</td>
<td class="instruction">LD H,$7E</td>
</tr>
<tr>
<td class="address-1"><span id="7e39"></span>7E39</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=original tune datum</td>
</tr>
<tr>
<td class="address-1"><span id="7e3a"></span>7E3A</td>
<td class="instruction">RLCA</td>
<td class="comment-1" rowspan="15">Obtain the note frequency parameter in <span class="register">E</span> and the note duration parameter in <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="7e3b"></span>7E3B</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="7e3c"></span>7E3C</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="7e3d"></span>7E3D</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="7e3e"></span>7E3E</td>
<td class="instruction">AND $0F</td>
</tr>
<tr>
<td class="address-1"><span id="7e40"></span>7E40</td>
<td class="instruction">LD B,A</td>
</tr>
<tr>
<td class="address-1"><span id="7e41"></span>7E41</td>
<td class="instruction">LD E,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="7e42"></span>7E42</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="7e43"></span>7E43</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="7e44"></span>7E44</td>
<td class="instruction">LD HL,$0000</td>
</tr>
<tr>
<td class="address-2"><span id="7e47"></span>7E47</td>
<td class="instruction">ADD HL,DE</td>
</tr>
<tr>
<td class="address-1"><span id="7e48"></span>7E48</td>
<td class="instruction">DJNZ $7E47</td>
</tr>
<tr>
<td class="address-1"><span id="7e4a"></span>7E4A</td>
<td class="instruction">RR H</td>
</tr>
<tr>
<td class="address-1"><span id="7e4c"></span>7E4C</td>
<td class="instruction">RR L</td>
</tr>
<tr>
<td class="address-1"><span id="7e4e"></span>7E4E</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-2"><span id="7e4f"></span>7E4F</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="10">Produce a note</td>
</tr>
<tr>
<td class="address-1"><span id="7e50"></span>7E50</td>
<td class="instruction">OUT ($FE),A</td>
</tr>
<tr>
<td class="address-1"><span id="7e52"></span>7E52</td>
<td class="instruction">XOR $10</td>
</tr>
<tr>
<td class="address-1"><span id="7e54"></span>7E54</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="address-1"><span id="7e55"></span>7E55</td>
<td class="instruction">LD B,E</td>
</tr>
<tr>
<td class="address-2"><span id="7e56"></span>7E56</td>
<td class="instruction">DJNZ $7E56</td>
</tr>
<tr>
<td class="address-1"><span id="7e58"></span>7E58</td>
<td class="instruction">DEC HL</td>
</tr>
<tr>
<td class="address-1"><span id="7e59"></span>7E59</td>
<td class="instruction">LD A,H</td>
</tr>
<tr>
<td class="address-1"><span id="7e5a"></span>7E5A</td>
<td class="instruction">OR L</td>
</tr>
<tr>
<td class="address-1"><span id="7e5b"></span>7E5B</td>
<td class="instruction">JR NZ,$7E4F</td>
</tr>
<tr>
<td class="address-1"><span id="7e5d"></span>7E5D</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the pointer to the tune data table</td>
</tr>
<tr>
<td class="address-1"><span id="7e5e"></span>7E5E</td>
<td class="instruction">JP $7E18</td>
<td class="comment-1" rowspan="1">Pick up the next tune datum</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="7E07.html">7E07</a>
</td>
<td class="up">Up: <a href="../maps/all.html#7e17">Map</a></td>
<td class="next">
Next: <a href="7E61.html">7E61</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze RAM disassembly 20210310</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd. &#169; 2021 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.4.</div>
<div><a href="../dec/asm/32279.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>