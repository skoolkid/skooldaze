<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at F855</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Skool Daze" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="F800.html">F800</a>
</td>
<td class="up">Up: <a href="../maps/all.html#f855">Map</a></td>
<td class="next">
Next: <a href="F8B2.html">F8B2</a>
</td>
</tr>
</table>
<div class="description">F855: Generate a safe combination code and set MR CREAK's birth year</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="F8B4.html">F8B4</a>. Generates a new safe combination code, sets a new random birth year for MR CREAK, and adjusts the game mode (so that all the shields need to be flashed again).
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">0x00</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="f855"></span>F855</td>
<td class="instruction">LD HL,$7FB8</td>
<td class="comment-1" rowspan="5">Clear the safe combination code (stored at <a href="7F9F.html">7F9F</a>), the teachers' combination letters (stored at <a href="7FA3.html">7FA3</a>), and the blackboard contents buffers (at <a href="7FA8.html">7FA8</a>, <a href="7FAE.html">7FAE</a> and <a href="7FB4.html">7FB4</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="f858"></span>F858</td>
<td class="instruction">LD B,$19</td>
</tr>
<tr>
<td class="address-2"><span id="f85a"></span>F85A</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="f85b"></span>F85B</td>
<td class="instruction">DEC L</td>
</tr>
<tr>
<td class="address-1"><span id="f85c"></span>F85C</td>
<td class="instruction">DJNZ $F85A</td>
</tr>
<tr>
<td class="address-1"><span id="f85e"></span>F85E</td>
<td class="instruction">LD D,A</td>
<td class="comment-1" rowspan="2"><span class="register">DE</span>=0000</td>
</tr>
<tr>
<td class="address-1"><span id="f85f"></span>F85F</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="f860"></span>F860</td>
<td class="instruction">LD C,$04</td>
<td class="comment-1" rowspan="1">There are four letters in the combination</td>
</tr>
<tr>
<td class="address-1"><span id="f862"></span>F862</td>
<td class="instruction">CALL <a href="61A1.html">$61A1</a></td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=random number</td>
</tr>
<tr>
<td class="address-1"><span id="f865"></span>F865</td>
<td class="instruction">AND $0F</td>
<td class="comment-1" rowspan="1">0x00&lt;=<span class="register">A</span>&lt;=0x0F</td>
</tr>
<tr>
<td class="address-1"><span id="f867"></span>F867</td>
<td class="instruction">JR $F87C</td>
<td class="comment-1" rowspan="1">Store MR WACKER's safe combination letter first (at <a href="7F9F.html">7F9F</a>)</td>
</tr>
<tr>
<td class="address-2"><span id="f869"></span>F869</td>
<td class="instruction">LD L,$9F</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="7F9F.html">7F9F</a> (first letter of the safe combination code)</td>
</tr>
<tr>
<td class="address-1"><span id="f86b"></span>F86B</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="7F9F.html">7F9F</a>+<span class="register">C</span> (1&lt;=<span class="register">C</span>&lt;=3)</td>
</tr>
<tr>
<td class="address-2"><span id="f86c"></span>F86C</td>
<td class="instruction">CALL <a href="61A1.html">$61A1</a></td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=random number</td>
</tr>
<tr>
<td class="address-1"><span id="f86f"></span>F86F</td>
<td class="instruction">LD E,B</td>
<td class="comment-1" rowspan="1"><span class="register">E</span>=0</td>
</tr>
<tr>
<td class="address-1"><span id="f870"></span>F870</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="4">Get a random number between 0 and 3 in <span class="register">E</span></td>
</tr>
<tr>
<td class="address-1"><span id="f871"></span>F871</td>
<td class="instruction">RL E</td>
</tr>
<tr>
<td class="address-1"><span id="f873"></span>F873</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="f874"></span>F874</td>
<td class="instruction">RL E</td>
</tr>
<tr>
<td class="address-1"><span id="f876"></span>F876</td>
<td class="instruction">AND $1F</td>
<td class="comment-1" rowspan="2">Is <span class="register">A</span> between 0x00 and 0x19?</td>
</tr>
<tr>
<td class="address-1"><span id="f878"></span>F878</td>
<td class="instruction">CP $1A</td>
</tr>
<tr>
<td class="address-1"><span id="f87a"></span>F87A</td>
<td class="instruction">JR NC,$F86C</td>
<td class="comment-1" rowspan="1">Jump back if not</td>
</tr>
<tr>
<td class="address-2"><span id="f87c"></span>F87C</td>
<td class="instruction">ADD A,$41</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=ASCII code of an upper case letter</td>
</tr>
<tr>
<td class="address-1"><span id="f87e"></span>F87E</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Store this in one of the slots at <a href="7F9F.html">7F9F</a></td>
</tr>
<tr>
<td class="address-1"><span id="f87f"></span>F87F</td>
<td class="instruction">LD L,$A3</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL</span> at a random teacher's safe combination letter</td>
</tr>
<tr>
<td class="address-1"><span id="f881"></span>F881</td>
<td class="instruction">ADD HL,DE</td>
</tr>
<tr>
<td class="address-1"><span id="f882"></span>F882</td>
<td class="instruction">BIT 6,(HL)</td>
<td class="comment-1" rowspan="1">Has this letter already been decided?</td>
</tr>
<tr>
<td class="address-1"><span id="f884"></span>F884</td>
<td class="instruction">JR NZ,$F869</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="f886"></span>F886</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Store the ASCII code in one of the four slots at <a href="7FA3.html">7FA3</a></td>
</tr>
<tr>
<td class="address-1"><span id="f887"></span>F887</td>
<td class="instruction">DEC C</td>
<td class="comment-1" rowspan="1">Next combination letter</td>
</tr>
<tr>
<td class="address-1"><span id="f888"></span>F888</td>
<td class="instruction">JR NZ,$F869</td>
<td class="comment-1" rowspan="1">Jump back until all four combination letters are done</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f88a"></span>
<div class="comments">
<div class="paragraph">
The safe combination code has been generated. Now for MR CREAK's birth year.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="f88a"></span>F88A</td>
<td class="instruction">LD L,$9A</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="7F9A.html">7F9A</a> (which holds the identifier for CREAK's birth year battle)</td>
</tr>
<tr>
<td class="address-2"><span id="f88c"></span>F88C</td>
<td class="instruction">CALL <a href="61A1.html">$61A1</a></td>
<td class="comment-1" rowspan="3">Get a random number between 0x00 and 0x14 in <span class="register">A</span></td>
</tr>
<tr>
<td class="address-1"><span id="f88f"></span>F88F</td>
<td class="instruction">CP $15</td>
</tr>
<tr>
<td class="address-1"><span id="f891"></span>F891</td>
<td class="instruction">JR NC,$F88C</td>
</tr>
<tr>
<td class="address-1"><span id="f893"></span>F893</td>
<td class="instruction">ADD A,A</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=random odd number between 0xD5 and 0xFD</td>
</tr>
<tr>
<td class="address-1"><span id="f894"></span>F894</td>
<td class="instruction">ADD A,$D5</td>
</tr>
<tr>
<td class="address-1"><span id="f896"></span>F896</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Store this battle identifier at <a href="7F9A.html">7F9A</a></td>
</tr>
<tr>
<td class="address-1"><span id="f897"></span>F897</td>
<td class="instruction">SUB $81</td>
<td class="comment-1" rowspan="12">Set <span class="register">HL</span> to the address of the battle year message corresponding to this battle identifier</td>
</tr>
<tr>
<td class="address-1"><span id="f899"></span>F899</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="f89a"></span>F89A</td>
<td class="instruction">LD H,D</td>
</tr>
<tr>
<td class="address-1"><span id="f89b"></span>F89B</td>
<td class="instruction">LD L,D</td>
</tr>
<tr>
<td class="address-1"><span id="f89c"></span>F89C</td>
<td class="instruction">ADD HL,DE</td>
</tr>
<tr>
<td class="address-1"><span id="f89d"></span>F89D</td>
<td class="instruction">ADD HL,DE</td>
</tr>
<tr>
<td class="address-1"><span id="f89e"></span>F89E</td>
<td class="instruction">ADD HL,DE</td>
</tr>
<tr>
<td class="address-1"><span id="f89f"></span>F89F</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="address-1"><span id="f8a0"></span>F8A0</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="address-1"><span id="f8a1"></span>F8A1</td>
<td class="instruction">LD A,H</td>
</tr>
<tr>
<td class="address-1"><span id="f8a2"></span>F8A2</td>
<td class="instruction">ADD A,$DF</td>
</tr>
<tr>
<td class="address-1"><span id="f8a4"></span>F8A4</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="f8a5"></span>F8A5</td>
<td class="instruction">LD DE,$7F9B</td>
<td class="comment-1" rowspan="3">Store the digits of CREAK's birth year at <a href="7F9B.html">7F9B</a></td>
</tr>
<tr>
<td class="address-1"><span id="f8a8"></span>F8A8</td>
<td class="instruction">LD C,$04</td>
</tr>
<tr>
<td class="address-1"><span id="f8aa"></span>F8AA</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="f8ac"></span>
<div class="comments">
<div class="paragraph">
Finally, adjust the game mode.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="f8ac"></span>F8AC</td>
<td class="instruction">LD A,$01</td>
<td class="comment-1" rowspan="2">Set the game mode indicator at <a href="7FEA.html">7FEA</a> to 1, indicating that the shields need to be flashed</td>
</tr>
<tr>
<td class="address-1"><span id="f8ae"></span>F8AE</td>
<td class="instruction">LD ($7FEA),A</td>
</tr>
<tr>
<td class="address-1"><span id="f8b1"></span>F8B1</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="F800.html">F800</a>
</td>
<td class="up">Up: <a href="../maps/all.html#f855">Map</a></td>
<td class="next">
Next: <a href="F8B2.html">F8B2</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze RAM disassembly 20200809</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../dec/asm/63573.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>