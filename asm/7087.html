<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at 7087</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Skool Daze" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="7082.html">7082</a>
</td>
<td class="up">Up: <a href="../maps/all.html#7087">Map</a></td>
<td class="next">
Next: <a href="70D2.html">70D2</a>
</td>
</tr>
</table>
<div class="description">7087: Update the SRB for a blackboard or the speech bubble lip</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="7142.html">7142</a>, <a href="71E8.html">71E8</a>, <a href="734E.html">734E</a> and <a href="7432.html">7432</a>. Updates the <a href="7F0C.html">screen refresh buffer</a> (SRB) so that the character squares at (<span class="register">E</span>,<span class="register">D</span>) and (<span class="register">E</span>+1,<span class="register">D</span>) are marked dirty. Two character squares in a row are marked dirty to ensure that blackboard contents are properly displayed (characters written on a blackboard may cross character square boundaries).
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">D</td>
<td class="register-desc">Skool y-coordinate</td>
</tr>
<tr>
<td class="register">E</td>
<td class="register-desc">Skool x-coordinate</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="7087"></span>7087</td>
<td class="instruction">LD A,($7F00)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=X: leftmost column of the skool on screen (0-64)</td>
</tr>
<tr>
<td class="address-1"><span id="708a"></span>708A</td>
<td class="instruction">SUB $02</td>
<td class="comment-1" rowspan="7">Return unless X-1&lt;=<span class="register">E</span>&lt;=X+31 (i.e. unless the coordinates in <span class="register">DE</span> correspond to a skool location that is currently on-screen or just off to the left)</td>
</tr>
<tr>
<td class="address-1"><span id="708c"></span>708C</td>
<td class="instruction">JR C,$7090</td>
</tr>
<tr>
<td class="address-1"><span id="708e"></span>708E</td>
<td class="instruction">CP E</td>
</tr>
<tr>
<td class="address-1"><span id="708f"></span>708F</td>
<td class="instruction">RET NC</td>
</tr>
<tr>
<td class="address-2"><span id="7090"></span>7090</td>
<td class="instruction">ADD A,$21</td>
</tr>
<tr>
<td class="address-1"><span id="7092"></span>7092</td>
<td class="instruction">CP E</td>
</tr>
<tr>
<td class="address-1"><span id="7093"></span>7093</td>
<td class="instruction">RET C</td>
</tr>
<tr>
<td class="address-1"><span id="7094"></span>7094</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Store the skool coordinates</td>
</tr>
<tr>
<td class="address-1"><span id="7095"></span>7095</td>
<td class="instruction">SUB $20</td>
<td class="comment-1" rowspan="3"><span class="register">A</span>=<span class="register">E</span>-X (-1, 0-31)</td>
</tr>
<tr>
<td class="address-1"><span id="7097"></span>7097</td>
<td class="instruction">CPL</td>
</tr>
<tr>
<td class="address-1"><span id="7098"></span>7098</td>
<td class="instruction">ADD A,E</td>
</tr>
<tr>
<td class="address-1"><span id="7099"></span>7099</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-1" rowspan="1">Are the coordinates in <span class="register">DE</span> on-screen?</td>
</tr>
<tr>
<td class="address-1"><span id="709b"></span>709B</td>
<td class="instruction">JR Z,$709E</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="709d"></span>709D</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=0</td>
</tr>
<tr>
<td class="address-2"><span id="709e"></span>709E</td>
<td class="instruction">RLCA</td>
<td class="comment-1" rowspan="3"><span class="register">A</span>=8x (x=0-31, the screen x-coordinate)</td>
</tr>
<tr>
<td class="address-1"><span id="709f"></span>709F</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="70a0"></span>70A0</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="70a1"></span>70A1</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1">Save this value in <span class="register">E</span> briefly</td>
</tr>
<tr>
<td class="address-1"><span id="70a2"></span>70A2</td>
<td class="instruction">AND $38</td>
<td class="comment-1" rowspan="3">Modify the SET m,(HL) instruction at <a href="7087.html#70b9">70B9</a> below</td>
</tr>
<tr>
<td class="address-1"><span id="70a4"></span>70A4</td>
<td class="instruction">ADD A,$C6</td>
</tr>
<tr>
<td class="address-1"><span id="70a6"></span>70A6</td>
<td class="instruction">LD ($70BA),A</td>
</tr>
<tr>
<td class="address-1"><span id="70a9"></span>70A9</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="13">Point <span class="register">HL</span> at the appropriate byte in the screen refresh buffer</td>
</tr>
<tr>
<td class="address-1"><span id="70aa"></span>70AA</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="70ab"></span>70AB</td>
<td class="instruction">RLCA</td>
</tr>
<tr>
<td class="address-1"><span id="70ac"></span>70AC</td>
<td class="instruction">AND $03</td>
</tr>
<tr>
<td class="address-1"><span id="70ae"></span>70AE</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="70af"></span>70AF</td>
<td class="instruction">LD A,D</td>
</tr>
<tr>
<td class="address-1"><span id="70b0"></span>70B0</td>
<td class="instruction">SUB $95</td>
</tr>
<tr>
<td class="address-1"><span id="70b2"></span>70B2</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="70b3"></span>70B3</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="70b4"></span>70B4</td>
<td class="instruction">ADD A,E</td>
</tr>
<tr>
<td class="address-1"><span id="70b5"></span>70B5</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="70b6"></span>70B6</td>
<td class="instruction">LD D,$7F</td>
</tr>
<tr>
<td class="address-1"><span id="70b8"></span>70B8</td>
<td class="instruction">EX DE,HL</td>
</tr>
<tr>
<td class="address-1"><span id="70b9"></span>70B9</td>
<td class="instruction">SET 0,(HL)</td>
<td class="comment-1" rowspan="1">Set the appropriate bit in the SRB byte; this instruction is modified earlier in this routine to set the required bit</td>
</tr>
<tr>
<td class="address-1"><span id="70bb"></span>70BB</td>
<td class="instruction">LD A,($70BA)</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="70be"></span>70BE</td>
<td class="instruction">ADD A,$08</td>
<td class="comment-1" rowspan="1">Was m=7?</td>
</tr>
<tr>
<td class="address-1"><span id="70c0"></span>70C0</td>
<td class="instruction">JR NC,$70CA</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="70c2"></span>70C2</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Move to the next SRB byte</td>
</tr>
<tr>
<td class="address-1"><span id="70c3"></span>70C3</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="2"><span class="register">A</span> will be 0 if we wrapped round to the next row of the screen</td>
</tr>
<tr>
<td class="address-1"><span id="70c4"></span>70C4</td>
<td class="instruction">AND $03</td>
</tr>
<tr>
<td class="address-1"><span id="70c6"></span>70C6</td>
<td class="instruction">LD A,$C6</td>
<td class="comment-1" rowspan="1">0xC6 will set n=0</td>
</tr>
<tr>
<td class="address-1"><span id="70c8"></span>70C8</td>
<td class="instruction">JR Z,$70CF</td>
<td class="comment-1" rowspan="1">Jump if we wrapped round to the next row</td>
</tr>
<tr>
<td class="address-2"><span id="70ca"></span>70CA</td>
<td class="instruction">LD ($70CE),A</td>
<td class="comment-1" rowspan="1">Modify the SET n,(HL) instruction below so that n=m+1 mod 8</td>
</tr>
<tr>
<td class="address-1"><span id="70cd"></span>70CD</td>
<td class="instruction">SET 0,(HL)</td>
<td class="comment-1" rowspan="1">Set the appropriate bit in the SRB byte; this instruction is modified immediately before execution to set the required bit</td>
</tr>
<tr>
<td class="address-2"><span id="70cf"></span>70CF</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="70d0"></span>70D0</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Restore the skool coordinates to <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="70d1"></span>70D1</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="7082.html">7082</a>
</td>
<td class="up">Up: <a href="../maps/all.html#7087">Map</a></td>
<td class="next">
Next: <a href="70D2.html">70D2</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze RAM disassembly 20200809</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../dec/asm/28807.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>