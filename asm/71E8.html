<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at 71E8</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Skool Daze" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="71E1.html">71E1</a>
</td>
<td class="up">Up: <a href="../maps/all.html#71e8">Map</a></td>
<td class="next">
Next: <a href="725E.html">725E</a>
</td>
</tr>
</table>
<div class="description">71E8: Make a teacher wipe a blackboard (2)</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Continues from <a href="71DC.html">71DC</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">Blackboard identifier (0xEC, 0xEE or 0xF0)</td>
</tr>
<tr>
<td class="register">DE</td>
<td class="register-desc">Coordinates of the top-left corner of the blackboard</td>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Teacher's character number (0xA3-0xA6)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="71e8"></span>71E8</td>
<td class="instruction">LD L,$69</td>
<td class="comment-1" rowspan="2">Replace the address of the interruptible subcommand routine at <a href="71DC.html">71DC</a> in bytes 0x69 and 0x6A of the teacher's buffer with <a href="71E8.html#71f7">71F7</a> (below)</td>
</tr>
<tr>
<td class="address-1"><span id="71ea"></span>71EA</td>
<td class="instruction">LD (HL),$F7</td>
</tr>
<tr>
<td class="address-1"><span id="71ec"></span>71EC</td>
<td class="instruction">LD L,$6B</td>
<td class="comment-1" rowspan="2">Wiping a blackboard requires 32 distinct actions (in 8 groups of 4: two paces forward, arm up, arm down)</td>
</tr>
<tr>
<td class="address-1"><span id="71ee"></span>71EE</td>
<td class="instruction">LD (HL),$20</td>
</tr>
<tr>
<td class="address-1"><span id="71f0"></span>71F0</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="4">Store the x-coordinate of the rightmost column of the blackboard (which will be wiped first) in byte 0x6C of the teacher's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="71f1"></span>71F1</td>
<td class="instruction">LD A,E</td>
</tr>
<tr>
<td class="address-1"><span id="71f2"></span>71F2</td>
<td class="instruction">ADD A,$07</td>
</tr>
<tr>
<td class="address-1"><span id="71f4"></span>71F4</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="71f5"></span>71F5</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="2">Store the y-coordinate of the top row of the blackboard in byte 0x6D of the teacher's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="71f6"></span>71F6</td>
<td class="instruction">LD (HL),D</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="71f7"></span>
<div class="comments">
<div class="paragraph">
After the initial call to this routine, each subsequent call enters here.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="71f7"></span>71F7</td>
<td class="instruction">LD L,$6B</td>
<td class="comment-1" rowspan="2">Decrement the number of board-wiping actions remaining</td>
</tr>
<tr>
<td class="address-1"><span id="71f9"></span>71F9</td>
<td class="instruction">DEC (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="71fa"></span>71FA</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-1" rowspan="1">Has the teacher finished wiping the board?</td>
</tr>
<tr>
<td class="address-1"><span id="71fc"></span>71FC</td>
<td class="instruction">JR NZ,$7250</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="71fe"></span>71FE</td>
<td class="instruction">CALL <a href="6214.html">$6214</a></td>
<td class="comment-1" rowspan="1">Update the SRB for the teacher's current location</td>
</tr>
<tr>
<td class="address-1"><span id="7201"></span>7201</td>
<td class="instruction">LD L,$6B</td>
<td class="comment-1" rowspan="2">Is the teacher midstride or is his arm raised?</td>
</tr>
<tr>
<td class="address-1"><span id="7203"></span>7203</td>
<td class="instruction">BIT 0,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="7205"></span>7205</td>
<td class="instruction">JR Z,$7240</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="7207"></span>7207</td>
<td class="instruction">BIT 1,(HL)</td>
<td class="comment-1" rowspan="1">Is the teacher ready to raise his arm (and wipe)?</td>
</tr>
<tr>
<td class="address-1"><span id="7209"></span>7209</td>
<td class="instruction">JR Z,$720F</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="720b"></span>720B</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=animatory state of the teacher midstride</td>
</tr>
<tr>
<td class="address-1"><span id="720c"></span>720C</td>
<td class="instruction">JP <a href="61B0.html">$61B0</a></td>
<td class="comment-1" rowspan="1">Update the teacher's animatory state and update the SRB</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="720f"></span>
<div class="comments">
<div class="paragraph">
The teacher is ready to raise his arm and wipe a column of the board.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="720f"></span>720F</td>
<td class="instruction">ADD A,$05</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=animatory state of the teacher with his arm raised</td>
</tr>
<tr>
<td class="address-1"><span id="7211"></span>7211</td>
<td class="instruction">CP $48</td>
<td class="comment-1" rowspan="1">Are we actually dealing with a teacher?</td>
</tr>
<tr>
<td class="address-1"><span id="7213"></span>7213</td>
<td class="instruction">JR NC,$7217</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="7215"></span>7215</td>
<td class="instruction">ADD A,$08</td>
<td class="comment-1" rowspan="1">If ANGELFACE or BOY WANDER were wiping the board, <span class="register">A</span> would now hold the animatory state of the boy with his arm raised</td>
</tr>
<tr>
<td class="address-2"><span id="7217"></span>7217</td>
<td class="instruction">CALL <a href="61B0.html">$61B0</a></td>
<td class="comment-1" rowspan="1">Update the teacher's animatory state and update the SRB</td>
</tr>
<tr>
<td class="address-1"><span id="721a"></span>721A</td>
<td class="instruction">LD L,$6C</td>
<td class="comment-1" rowspan="2"><span class="register">E</span>=x-coordinate of the blackboard column to wipe</td>
</tr>
<tr>
<td class="address-1"><span id="721c"></span>721C</td>
<td class="instruction">LD E,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="721d"></span>721D</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-1" rowspan="1">Decrement the blackboard column x-coordinate</td>
</tr>
<tr>
<td class="address-1"><span id="721e"></span>721E</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="2"><span class="register">D</span>=y-coordinate of the top row of the blackboard column to wipe</td>
</tr>
<tr>
<td class="address-1"><span id="721f"></span>721F</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="7220"></span>7220</td>
<td class="instruction">CALL <a href="7087.html">$7087</a></td>
<td class="comment-1" rowspan="3">Update the SRB for the upper and lower character squares of the blackboard column that will be wiped</td>
</tr>
<tr>
<td class="address-1"><span id="7223"></span>7223</td>
<td class="instruction">INC D</td>
</tr>
<tr>
<td class="address-1"><span id="7224"></span>7224</td>
<td class="instruction">CALL <a href="7087.html">$7087</a></td>
</tr>
<tr>
<td class="address-1"><span id="7227"></span>7227</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="2"><span class="register">L</span>=skool UDG reference for the lower character square of the blackboard column</td>
</tr>
<tr>
<td class="address-1"><span id="7228"></span>7228</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="7229"></span>7229</td>
<td class="instruction">ADD A,$08</td>
<td class="comment-1" rowspan="2"><span class="register">E</span>=skool UDG reference for the upper character square of the blackboard column</td>
</tr>
<tr>
<td class="address-1"><span id="722b"></span>722B</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="722c"></span>722C</td>
<td class="instruction">LD H,$80</td>
<td class="comment-1" rowspan="5">Point <span class="register">HL</span> at the base address of the UDG data for the lower character square of the blackboard column, and <span class="register">DE</span> at the base address of the UDG data for the upper character square of the blackboard column</td>
</tr>
<tr>
<td class="address-1"><span id="722e"></span>722E</td>
<td class="instruction">CP $E9</td>
</tr>
<tr>
<td class="address-1"><span id="7230"></span>7230</td>
<td class="instruction">JR NC,$7234</td>
</tr>
<tr>
<td class="address-1"><span id="7232"></span>7232</td>
<td class="instruction">LD H,$88</td>
</tr>
<tr>
<td class="address-2"><span id="7234"></span>7234</td>
<td class="instruction">LD D,H</td>
</tr>
<tr>
<td class="address-1"><span id="7235"></span>7235</td>
<td class="instruction">LD B,$08</td>
<td class="comment-1" rowspan="1">There are 8 bytes in a UDG</td>
</tr>
<tr>
<td class="address-1"><span id="7237"></span>7237</td>
<td class="instruction">LD A,$FF</td>
<td class="comment-1" rowspan="1">All bits set means clean (no chalk)</td>
</tr>
<tr>
<td class="address-2"><span id="7239"></span>7239</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="5">Wipe the blackboard column clean by altering the skool UDG data directly</td>
</tr>
<tr>
<td class="address-1"><span id="723a"></span>723A</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="address-1"><span id="723b"></span>723B</td>
<td class="instruction">INC H</td>
</tr>
<tr>
<td class="address-1"><span id="723c"></span>723C</td>
<td class="instruction">INC D</td>
</tr>
<tr>
<td class="address-1"><span id="723d"></span>723D</td>
<td class="instruction">DJNZ $7239</td>
</tr>
<tr>
<td class="address-1"><span id="723f"></span>723F</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7240"></span>
<div class="comments">
<div class="paragraph">
The teacher is midstride or his arm is raised.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="7240"></span>7240</td>
<td class="instruction">AND $F8</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=base animatory state of the teacher</td>
</tr>
<tr>
<td class="address-1"><span id="7242"></span>7242</td>
<td class="instruction">CP $48</td>
<td class="comment-1" rowspan="1">Are we actually dealing with a teacher?</td>
</tr>
<tr>
<td class="address-1"><span id="7244"></span>7244</td>
<td class="instruction">JR NC,$7248</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="7246"></span>7246</td>
<td class="instruction">AND $F0</td>
<td class="comment-1" rowspan="1">If ANGELFACE or BOY WANDER were wiping the board, <span class="register">A</span> would now hold the base animatory state of the boy</td>
</tr>
<tr>
<td class="address-2"><span id="7248"></span>7248</td>
<td class="instruction">BIT 1,(HL)</td>
<td class="comment-1" rowspan="1">Is the teacher's arm raised?</td>
</tr>
<tr>
<td class="address-1"><span id="724a"></span>724A</td>
<td class="instruction">JR Z,$724D</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="724c"></span>724C</td>
<td class="instruction">DEC E</td>
<td class="comment-1" rowspan="1">The teacher was midstride, so move him forward to the next blackboard column</td>
</tr>
<tr>
<td class="address-2"><span id="724d"></span>724D</td>
<td class="instruction">JP <a href="61B0.html">$61B0</a></td>
<td class="comment-1" rowspan="1">Update the teacher's animatory state and location and update the SRB</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7250"></span>
<div class="comments">
<div class="paragraph">
The teacher has finished wiping the board.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="7250"></span>7250</td>
<td class="instruction">CALL <a href="7128.html">$7128</a></td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=identifier of the blackboard the teacher is next to</td>
</tr>
<tr>
<td class="address-1"><span id="7253"></span>7253</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="2"><span class="register">HL</span>=<a href="7FEC.html">7FEC</a> (Reading Room blackboard), <a href="7FEE.html">7FEE</a> (White Room blackboard), or <a href="7FF0.html">7FF0</a> (Exam Room blackboard)</td>
</tr>
<tr>
<td class="address-1"><span id="7254"></span>7254</td>
<td class="instruction">LD H,$7F</td>
</tr>
<tr>
<td class="address-1"><span id="7256"></span>7256</td>
<td class="instruction">LD (HL),$01</td>
<td class="comment-1" rowspan="1">The first clean pixel column is now column no. 1</td>
</tr>
<tr>
<td class="address-1"><span id="7258"></span>7258</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="2">Signal: no one has written on this blackboard</td>
</tr>
<tr>
<td class="address-1"><span id="7259"></span>7259</td>
<td class="instruction">LD (HL),$00</td>
</tr>
<tr>
<td class="address-1"><span id="725b"></span>725B</td>
<td class="instruction">JP <a href="62A0.html#62a4">$62A4</a></td>
<td class="comment-1" rowspan="1">Terminate this interruptible subcommand</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="71E1.html">71E1</a>
</td>
<td class="up">Up: <a href="../maps/all.html#71e8">Map</a></td>
<td class="next">
Next: <a href="725E.html">725E</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze RAM disassembly 20221122</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../dec/asm/29160.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>