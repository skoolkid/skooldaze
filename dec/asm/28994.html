<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at 28994</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Skool Daze" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="28968.html">28968</a>
</td>
<td class="up">Up: <a href="../maps/all.html#28994">Map</a></td>
<td class="next">
Next: <a href="29137.html">29137</a>
</td>
</tr>
</table>
<div class="description">28994: Write a single character on a blackboard</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="29284.html">29284</a>. Returns with the zero flag set if the end of the message has been reached.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Number of the character writing on the board (163-167)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="28994"></span>28994</td>
<td class="instruction">CALL <a href="28882.html">28882</a></td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=next character in the message being written</td>
</tr>
<tr>
<td class="address-1"><span id="28997"></span>28997</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Save this in <span class="register">B</span> briefly</td>
</tr>
<tr>
<td class="address-1"><span id="28998"></span>28998</td>
<td class="instruction">CALL <a href="28968.html">28968</a></td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=identifier of the blackboard being written on</td>
</tr>
<tr>
<td class="address-1"><span id="29001"></span>29001</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Transfer this to <span class="register">C</span></td>
</tr>
<tr>
<td class="address-1"><span id="29002"></span>29002</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=next character in the message being written</td>
</tr>
<tr>
<td class="address-1"><span id="29003"></span>29003</td>
<td class="instruction">LD B,127</td>
<td class="comment-1" rowspan="1">Point <span class="register">BC</span> at the appropriate blackboard buffer</td>
</tr>
<tr>
<td class="address-1"><span id="29005"></span>29005</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is the message finished?</td>
</tr>
<tr>
<td class="address-1"><span id="29006"></span>29006</td>
<td class="instruction">JR NZ,29012</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="29008"></span>29008</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=255</td>
</tr>
<tr>
<td class="address-2"><span id="29009"></span>29009</td>
<td class="instruction">LD (BC),A</td>
<td class="comment-1" rowspan="1">Store the pixel coordinates of the next character to be written on the board</td>
</tr>
<tr>
<td class="address-1"><span id="29010"></span>29010</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1">Set the zero flag if the message is finished</td>
</tr>
<tr>
<td class="address-1"><span id="29011"></span>29011</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="29012"></span>
<div class="comments">
<div class="paragraph">
The character has not finished writing on the blackboard. <span class="register">A</span> holds the ASCII code of the next letter to be written.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="29012"></span>29012</td>
<td class="instruction">CP 2</td>
<td class="comment-1" rowspan="1">Is it newline?</td>
</tr>
<tr>
<td class="address-1"><span id="29014"></span>29014</td>
<td class="instruction">JR NZ,29023</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="29016"></span>29016</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="3">Pick up the contents of <a href="32748.html">32748</a> (Reading Room blackboard), <a href="32750.html">32750</a> (White Room blackboard) or <a href="32752.html">32752</a> (Exam Room blackboard) and set it to 0 (start of top line) or 64 (start of bottom line)</td>
</tr>
<tr>
<td class="address-1"><span id="29017"></span>29017</td>
<td class="instruction">AND 64</td>
</tr>
<tr>
<td class="address-1"><span id="29019"></span>29019</td>
<td class="instruction">XOR 64</td>
</tr>
<tr>
<td class="address-1"><span id="29021"></span>29021</td>
<td class="instruction">JR 29009</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="29023"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="63146.html">63146</a> when ERIC is writing on a blackboard with <span class="register">BC</span>=<a href="32680.html#32684">32684</a> (Reading Room blackboard), <a href="32686.html#32690">32690</a> (White Room blackboard), or <a href="32692.html#32696">32696</a> (Exam Room blackboard).
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="29023"></span>29023</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="29024"></span>29024</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="2">Point <span class="register">HL</span> at the address holding the pixel width of the character to be written on the board</td>
</tr>
<tr>
<td class="address-1"><span id="29025"></span>29025</td>
<td class="instruction">LD H,217</td>
</tr>
<tr>
<td class="address-1"><span id="29027"></span>29027</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=pixel coordinates (0-127) of the location at which the character will be written</td>
</tr>
<tr>
<td class="address-1"><span id="29028"></span>29028</td>
<td class="instruction">AND 63</td>
<td class="comment-1" rowspan="1">Discard bit 6 (the line indicator bit)</td>
</tr>
<tr>
<td class="address-1"><span id="29030"></span>29030</td>
<td class="instruction">ADD A,192</td>
<td class="comment-1" rowspan="3">Set the carry flag if there is not enough space at the end of the current line to print the character</td>
</tr>
<tr>
<td class="address-1"><span id="29032"></span>29032</td>
<td class="instruction">SCF</td>
</tr>
<tr>
<td class="address-1"><span id="29033"></span>29033</td>
<td class="instruction">ADC A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="29034"></span>29034</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=pixel coordinates (0-127)</td>
</tr>
<tr>
<td class="address-1"><span id="29035"></span>29035</td>
<td class="instruction">JR NC,29042</td>
<td class="comment-1" rowspan="1">Jump if there is enough space to print the character on the current line</td>
</tr>
<tr>
<td class="address-1"><span id="29037"></span>29037</td>
<td class="instruction">AND 64</td>
<td class="comment-1" rowspan="3">Otherwise toggle which line (top or bottom) to write on and reset the pixel x-coordinate to 0 (start of the line)</td>
</tr>
<tr>
<td class="address-1"><span id="29039"></span>29039</td>
<td class="instruction">XOR 64</td>
</tr>
<tr>
<td class="address-1"><span id="29041"></span>29041</td>
<td class="instruction">LD (BC),A</td>
</tr>
<tr>
<td class="address-2"><span id="29042"></span>29042</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="10">Compute the skool coordinates of the location of the character to be written and store them in <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="29043"></span>29043</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="29044"></span>29044</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="29045"></span>29045</td>
<td class="instruction">AND 15</td>
</tr>
<tr>
<td class="address-1"><span id="29047"></span>29047</td>
<td class="instruction">CP 8</td>
</tr>
<tr>
<td class="address-1"><span id="29049"></span>29049</td>
<td class="instruction">JR C,29054</td>
</tr>
<tr>
<td class="address-1"><span id="29051"></span>29051</td>
<td class="instruction">INC D</td>
</tr>
<tr>
<td class="address-1"><span id="29052"></span>29052</td>
<td class="instruction">AND 7</td>
</tr>
<tr>
<td class="address-2"><span id="29054"></span>29054</td>
<td class="instruction">ADD A,E</td>
</tr>
<tr>
<td class="address-1"><span id="29055"></span>29055</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="29056"></span>29056</td>
<td class="instruction">CALL <a href="28807.html">28807</a></td>
<td class="comment-1" rowspan="1">Update the screen refresh buffer for these coordinates</td>
</tr>
<tr>
<td class="address-1"><span id="29059"></span>29059</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="8">Modify the RES n,(HL) instruction at <a href="28994.html#29102">29102</a> below, which in effect draws a white pixel (of chalk) at the appropriate spot</td>
</tr>
<tr>
<td class="address-1"><span id="29060"></span>29060</td>
<td class="instruction">AND 7</td>
</tr>
<tr>
<td class="address-1"><span id="29062"></span>29062</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="29063"></span>29063</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="29064"></span>29064</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address-1"><span id="29065"></span>29065</td>
<td class="instruction">CPL</td>
</tr>
<tr>
<td class="address-1"><span id="29066"></span>29066</td>
<td class="instruction">SUB 65</td>
</tr>
<tr>
<td class="address-1"><span id="29068"></span>29068</td>
<td class="instruction">LD (29103),A</td>
</tr>
<tr>
<td class="address-1"><span id="29071"></span>29071</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-1" rowspan="4">Compute the pixel x-coordinate (0-63) of the rightmost pixel column of the character to be written on the board, and store it in the blackboard buffer</td>
</tr>
<tr>
<td class="address-1"><span id="29072"></span>29072</td>
<td class="instruction">ADD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="29073"></span>29073</td>
<td class="instruction">INC A</td>
</tr>
<tr>
<td class="address-1"><span id="29074"></span>29074</td>
<td class="instruction">LD (BC),A</td>
</tr>
<tr>
<td class="address-1"><span id="29075"></span>29075</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">C</span>=pixel width of the character to be written on the board</td>
</tr>
<tr>
<td class="address-1"><span id="29076"></span>29076</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL</span> at the skool UDG reference of the character square of the blackboard that will be written on and pick it up in <span class="register">L</span></td>
</tr>
<tr>
<td class="address-1"><span id="29077"></span>29077</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="29078"></span>29078</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="29079"></span>
<div class="comments">
<div class="paragraph">
Now we enter the loop that draws the pixel columns of the font character bitmap onto the blackboard.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="29079"></span>29079</td>
<td class="instruction">LD H,128</td>
<td class="comment-1" rowspan="8">Point <span class="register">HL</span> at the graphic data for the skool UDG reference in <span class="register">A</span>; the skool UDG references are 206-191 for the Reading Room board, 238-223 for the White Room board, and 222-207 for the Exam Room board, decreasing from left to right</td>
</tr>
<tr>
<td class="address-1"><span id="29081"></span>29081</td>
<td class="instruction">CP 233</td>
</tr>
<tr>
<td class="address-1"><span id="29083"></span>29083</td>
<td class="instruction">JR NC,29095</td>
</tr>
<tr>
<td class="address-1"><span id="29085"></span>29085</td>
<td class="instruction">CP 231</td>
</tr>
<tr>
<td class="address-1"><span id="29087"></span>29087</td>
<td class="instruction">JR NC,29093</td>
</tr>
<tr>
<td class="address-1"><span id="29089"></span>29089</td>
<td class="instruction">CP 225</td>
</tr>
<tr>
<td class="address-1"><span id="29091"></span>29091</td>
<td class="instruction">JR NC,29095</td>
</tr>
<tr>
<td class="address-2"><span id="29093"></span>29093</td>
<td class="instruction">LD H,136</td>
</tr>
<tr>
<td class="address-2"><span id="29095"></span>29095</td>
<td class="instruction">INC D</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=next pixel column of the character to be written on the board</td>
</tr>
<tr>
<td class="address-1"><span id="29096"></span>29096</td>
<td class="instruction">LD A,(DE)</td>
</tr>
<tr>
<td class="address-1"><span id="29097"></span>29097</td>
<td class="instruction">LD B,8</td>
<td class="comment-1" rowspan="1">There are 8 pixels in a pixel column</td>
</tr>
<tr>
<td class="address-2"><span id="29099"></span>29099</td>
<td class="instruction">RLCA</td>
<td class="comment-1" rowspan="5">Draw the pixel column on the blackboard by directly resetting bits in the skool graphic data; any bits already reset by previous writing remain reset (the 'RES n,(HL)' instruction is modified earlier in this routine to reset the required bit)</td>
</tr>
<tr>
<td class="address-1"><span id="29100"></span>29100</td>
<td class="instruction">JR NC,29104</td>
</tr>
<tr>
<td class="address-1"><span id="29102"></span>29102</td>
<td class="instruction">RES 7,(HL)</td>
</tr>
<tr>
<td class="address-2"><span id="29104"></span>29104</td>
<td class="instruction">INC H</td>
</tr>
<tr>
<td class="address-1"><span id="29105"></span>29105</td>
<td class="instruction">DJNZ 29099</td>
</tr>
<tr>
<td class="address-1"><span id="29107"></span>29107</td>
<td class="instruction">DEC C</td>
<td class="comment-1" rowspan="1">Next pixel column</td>
</tr>
<tr>
<td class="address-1"><span id="29108"></span>29108</td>
<td class="instruction">JR Z,29134</td>
<td class="comment-1" rowspan="1">Jump if we've finished drawing the character on the board</td>
</tr>
<tr>
<td class="address-1"><span id="29110"></span>29110</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL</span> back at the top pixel row of the skool UDG data</td>
</tr>
<tr>
<td class="address-1"><span id="29111"></span>29111</td>
<td class="instruction">SUB 8</td>
</tr>
<tr>
<td class="address-1"><span id="29113"></span>29113</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="address-1"><span id="29114"></span>29114</td>
<td class="instruction">LD A,(29103)</td>
<td class="comment-1" rowspan="5">Modify the RES n,(HL) instruction at <a href="28994.html#29102">29102</a> above to RES m,(HL) where m=n-1 (mod 8), effectively moving one pixel column to the right</td>
</tr>
<tr>
<td class="address-1"><span id="29117"></span>29117</td>
<td class="instruction">OR 64</td>
</tr>
<tr>
<td class="address-1"><span id="29119"></span>29119</td>
<td class="instruction">SUB 8</td>
</tr>
<tr>
<td class="address-1"><span id="29121"></span>29121</td>
<td class="instruction">AND 191</td>
</tr>
<tr>
<td class="address-1"><span id="29123"></span>29123</td>
<td class="instruction">LD (29103),A</td>
</tr>
<tr>
<td class="address-1"><span id="29126"></span>29126</td>
<td class="instruction">CP 190</td>
<td class="comment-1" rowspan="1">Did we wrap round from bit 0 to bit 7?</td>
</tr>
<tr>
<td class="address-1"><span id="29128"></span>29128</td>
<td class="instruction">JR NZ,29095</td>
<td class="comment-1" rowspan="1">Continue drawing pixel columns in this character square if not</td>
</tr>
<tr>
<td class="address-1"><span id="29130"></span>29130</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=skool UDG reference of the next character square to the right on the blackboard</td>
</tr>
<tr>
<td class="address-1"><span id="29131"></span>29131</td>
<td class="instruction">LD A,L</td>
</tr>
<tr>
<td class="address-1"><span id="29132"></span>29132</td>
<td class="instruction">JR 29079</td>
<td class="comment-1" rowspan="1">Draw the next pixel column in the next character square</td>
</tr>
<tr>
<td class="address-2"><span id="29134"></span>29134</td>
<td class="instruction">INC C</td>
<td class="comment-1" rowspan="1">Reset the zero flag to indicate that the message isn't finished</td>
</tr>
<tr>
<td class="address-1"><span id="29135"></span>29135</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="address-1"><span id="29136"></span>29136</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="28968.html">28968</a>
</td>
<td class="up">Up: <a href="../maps/all.html#28994">Map</a></td>
<td class="next">
Next: <a href="29137.html">29137</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze RAM disassembly 20200809</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../../asm/7142.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>