<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at 25008</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Skool Daze" src="../../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="24993.html">24993</a></span></td>
<td class="up">Up: <a href="../maps/all.html#25008">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="25106.html">25106</a></span></td>
</tr>
</table>
<div class="description">25008: Update a character's animatory state and location and update the SRB</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by many routines. Sets the new animatory state and location of a character, and updates the <a href="32524.html">screen refresh buffer</a> (SRB) accordingly.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">New animatory state</td>
</tr>
<tr>
<td class="register">D</td>
<td class="register-desc">New y-coordinate (154-169)</td>
</tr>
<tr>
<td class="register">E</td>
<td class="register-desc">New x-coordinate (0-95)</td>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (152-172)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="25008"></span>25008</td>
<td class="bytes-0"></td>
<td class="instruction">LD L,96</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 96 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25010"></span>25010</td>
<td class="bytes-0"></td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">Set the new animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25011"></span>25011</td>
<td class="bytes-0"></td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">Store the new animatory state in <span class="register">B</span> for later</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25012"></span>25012</td>
<td class="bytes-0"></td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=97</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25013"></span>25013</td>
<td class="bytes-0"></td>
<td class="instruction">LD (HL),D</td>
<td class="comment-11" rowspan="1">Set the new y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25014"></span>25014</td>
<td class="bytes-0"></td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=98</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25015"></span>25015</td>
<td class="bytes-0"></td>
<td class="instruction">LD (HL),E</td>
<td class="comment-11" rowspan="1">Set the new x-coordinate</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="25016"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="25108.html">25108</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="25016"></span>25016</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,(32512)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=leftmost column of the skool on-screen (0-64)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25019"></span>25019</td>
<td class="bytes-0"></td>
<td class="instruction">SUB 3</td>
<td class="comment-11" rowspan="1">Is the far left of the skool in view?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25021"></span>25021</td>
<td class="bytes-0"></td>
<td class="instruction">JR C,25025</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25023"></span>25023</td>
<td class="bytes-0"></td>
<td class="instruction">CP E</td>
<td class="comment-11" rowspan="1">Is the character off-screen to the left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25024"></span>25024</td>
<td class="bytes-0"></td>
<td class="instruction">RET NC</td>
<td class="comment-11" rowspan="1">Return if so (SRB does not need updating)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="25025"></span>25025</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,34</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25027"></span>25027</td>
<td class="bytes-0"></td>
<td class="instruction">CP E</td>
<td class="comment-11" rowspan="1">Is the character off-screen to the right?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25028"></span>25028</td>
<td class="bytes-0"></td>
<td class="instruction">RET C</td>
<td class="comment-11" rowspan="1">Return if so (SRB does not need updating)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25029"></span>25029</td>
<td class="bytes-0"></td>
<td class="instruction">SUB 32</td>
<td class="comment-11" rowspan="3"><span class="register">A</span>=character's screen x-coordinate: -2&lt;=<span class="register">A</span>&lt;=31</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25031"></span>25031</td>
<td class="bytes-0"></td>
<td class="instruction">CPL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25032"></span>25032</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25033"></span>25033</td>
<td class="bytes-0"></td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save the character number</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25034"></span>25034</td>
<td class="bytes-0"></td>
<td class="instruction">LD L,B</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=character's new animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25035"></span>25035</td>
<td class="bytes-0"></td>
<td class="instruction">LD H,173</td>
<td class="comment-11" rowspan="1">Pages 173-176 store UDG references for the left column of the sprites</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25037"></span>25037</td>
<td class="bytes-0"></td>
<td class="instruction">BIT 7,A</td>
<td class="comment-11" rowspan="1">Is the left column of the sprite on-screen?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25039"></span>25039</td>
<td class="bytes-0"></td>
<td class="instruction">JR Z,25051</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25041"></span>25041</td>
<td class="bytes-0"></td>
<td class="instruction">LD H,177</td>
<td class="comment-11" rowspan="1">Pages 177-180 store UDG references for the middle column of the sprites</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25043"></span>25043</td>
<td class="bytes-0"></td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1">-1&lt;=<span class="register">A</span>&lt;=0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25044"></span>25044</td>
<td class="bytes-0"></td>
<td class="instruction">BIT 7,A</td>
<td class="comment-11" rowspan="1">Is the middle column of the sprite on-screen at the left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25046"></span>25046</td>
<td class="bytes-0"></td>
<td class="instruction">JR Z,25051</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25048"></span>25048</td>
<td class="bytes-0"></td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25049"></span>25049</td>
<td class="bytes-0"></td>
<td class="instruction">LD H,181</td>
<td class="comment-11" rowspan="1">Pages 181-184 store UDG references for the right column of the sprites</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="25051"></span>
<div class="comments">
<div class="paragraph">
At this point, <span class="register">A</span> holds the leftmost column of the screen (0-31) occupied by the character's sprite, and <span class="register">H</span> holds the page number (173, 177, 181) corresponding to the leftmost column of the sprite that appears on-screen.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="25051"></span>25051</td>
<td class="bytes-0"></td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="7">Set the instruction at <a href="27008.html#27015">27015</a> to SET n,(HL) where n is the appropriate bit of the SRB byte that needs to be set</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25052"></span>25052</td>
<td class="bytes-0"></td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25053"></span>25053</td>
<td class="bytes-0"></td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25054"></span>25054</td>
<td class="bytes-0"></td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25055"></span>25055</td>
<td class="bytes-0"></td>
<td class="instruction">AND 56</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25057"></span>25057</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,198</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25059"></span>25059</td>
<td class="bytes-0"></td>
<td class="instruction">LD (27016),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25062"></span>25062</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=8c (c=0-31: leftmost column of the screen occupied by the sprite)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25063"></span>25063</td>
<td class="bytes-0"></td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25064"></span>25064</td>
<td class="bytes-0"></td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25065"></span>25065</td>
<td class="bytes-0"></td>
<td class="instruction">AND 3</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=INT(c/8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25067"></span>25067</td>
<td class="bytes-0"></td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=INT(c/8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25068"></span>25068</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's y-coordinate (155-169)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25069"></span>25069</td>
<td class="bytes-0"></td>
<td class="instruction">SUB 149</td>
<td class="comment-11" rowspan="1">5&lt;=<span class="register">A</span>&lt;=20</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25071"></span>25071</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=4*(<span class="register">D</span>-149)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25072"></span>25072</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25073"></span>25073</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=4*(<span class="register">D</span>-149)+INT(c/8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25074"></span>25074</td>
<td class="bytes-0"></td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=12+4*(<span class="register">D</span>-152)+INT(c/8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25075"></span>25075</td>
<td class="bytes-0"></td>
<td class="instruction">LD D,127</td>
<td class="comment-11" rowspan="2">Now <span class="register">HL</span> points to the relevant byte of the <a href="32524.html">SRB</a>, and <span class="register">DE</span> points to the base address of the sprite UDG references</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25077"></span>25077</td>
<td class="bytes-0"></td>
<td class="instruction">EX DE,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="25078"></span>25078</td>
<td class="bytes-0"></td>
<td class="instruction">CALL <a href="27008.html">27008</a></td>
<td class="comment-11" rowspan="1">Update the SRB for one column of the character's sprite</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25081"></span>25081</td>
<td class="bytes-0"></td>
<td class="instruction">JR NZ,25104</td>
<td class="comment-11" rowspan="1">Jump if we just updated the SRB for the right column of the sprite</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25083"></span>25083</td>
<td class="bytes-0"></td>
<td class="instruction">SUB 16</td>
<td class="comment-11" rowspan="2">Point <span class="register">HL</span> back to the relevant byte of the SRB</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25085"></span>25085</td>
<td class="bytes-0"></td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25086"></span>25086</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,(27016)</td>
<td class="comment-11" rowspan="2">Prepare to change the instruction at <a href="27008.html#27015">27015</a> from SET n,(HL) to SET n+1,(HL)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25089"></span>25089</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="25091"></span>25091</td>
<td class="bytes-0"></td>
<td class="instruction">LD (27016),A</td>
<td class="comment-11" rowspan="1">Change the instruction at <a href="27008.html#27015">27015</a> from SET n,(HL) to SET n+1,(HL) or SET 0,(HL)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25094"></span>25094</td>
<td class="bytes-0"></td>
<td class="instruction">JR NC,25078</td>
<td class="comment-11" rowspan="1">Jump back unless the instruction at <a href="27008.html#27015">27015</a> should be changed to SET 0,(HL) now</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25096"></span>25096</td>
<td class="bytes-0"></td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">Move to the next byte of the SRB</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25097"></span>25097</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="2">The zero flag will be set now if we 'wrapped around' to the left side of the screen, i.e. the next column of the character sprite is off-screen to the right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25098"></span>25098</td>
<td class="bytes-0"></td>
<td class="instruction">AND 3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25100"></span>25100</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,198</td>
<td class="comment-11" rowspan="1">This will change the instruction at <a href="27008.html#27015">27015</a> to SET 0,(HL)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25102"></span>25102</td>
<td class="bytes-0"></td>
<td class="instruction">JR NZ,25091</td>
<td class="comment-11" rowspan="1">Jump back to consider the remaining on-screen columns of the sprite</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="25104"></span>25104</td>
<td class="bytes-0"></td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the character number (152-172) to <span class="register">H</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="25105"></span>25105</td>
<td class="bytes-0"></td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="24993.html">24993</a></span></td>
<td class="up">Up: <a href="../maps/all.html#25008">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="25106.html">25106</a></span></td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze RAM disassembly 20190614</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 7.2.</div>
<div><a href="../../asm/61B0.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>