<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at 63270</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Skool Daze" src="../../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="63242.html">63242</a>
</td>
<td class="up">Up: <a href="../maps/all.html#63270">Map</a></td>
<td class="next">
Next: <a href="63346.html">63346</a>
</td>
</tr>
</table>
<div class="description">63270: Check whether ERIC has jumped up to the safe or a shield (2)</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Continues from <a href="62750.html">62750</a>. Checks whether ERIC has jumped up to the safe or a shield, and makes it flash or unflash as appropriate.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">DE</td>
<td class="register-desc">Coordinates of ERIC's hand</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="63270"></span>63270</td>
<td class="instruction">LD A,(32746)</td>
<td class="comment-1" rowspan="1">Pick up the game mode indicator from <a href="32746.html">32746</a></td>
</tr>
<tr>
<td class="address-1"><span id="63273"></span>63273</td>
<td class="instruction">CP 2</td>
<td class="comment-1" rowspan="1">Are all the shields flashing?</td>
</tr>
<tr>
<td class="address-1"><span id="63275"></span>63275</td>
<td class="instruction">JP NZ,<a href="28102.html#28130">28130</a></td>
<td class="comment-1" rowspan="1">Jump if not (to check whether ERIC touched a shield)</td>
</tr>
<tr>
<td class="address-1"><span id="63278"></span>63278</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=y-coordinate of ERIC's hand</td>
</tr>
<tr>
<td class="address-1"><span id="63279"></span>63279</td>
<td class="instruction">CP 161</td>
<td class="comment-1" rowspan="1">This is the y-coordinate of the spot just under the safe in the staff room</td>
</tr>
<tr>
<td class="address-1"><span id="63281"></span>63281</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return if ERIC is not on the middle floor</td>
</tr>
<tr>
<td class="address-1"><span id="63282"></span>63282</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=x-coordinate of ERIC's hand</td>
</tr>
<tr>
<td class="address-1"><span id="63283"></span>63283</td>
<td class="instruction">CP 10</td>
<td class="comment-1" rowspan="1">Has ERIC jumped up to the safe?</td>
</tr>
<tr>
<td class="address-1"><span id="63285"></span>63285</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="63286"></span>
<div class="comments">
<div class="paragraph">
ERIC has jumped up to the safe. Can he open it?
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="63286"></span>63286</td>
<td class="instruction">LD HL,32749</td>
<td class="comment-1" rowspan="1"><a href="32749.html">32749</a> holds the number of the character who last wrote on the Reading Room blackboard</td>
</tr>
<tr>
<td class="address-1"><span id="63289"></span>63289</td>
<td class="instruction">LD DE,32680</td>
<td class="comment-1" rowspan="1"><a href="32680.html">32680</a>=Reading Room blackboard contents buffer</td>
</tr>
<tr>
<td class="address-1"><span id="63292"></span>63292</td>
<td class="instruction">LD C,3</td>
<td class="comment-1" rowspan="1">There are 3 blackboards</td>
</tr>
<tr>
<td class="address-2"><span id="63294"></span>63294</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=number of the character who last wrote on this board</td>
</tr>
<tr>
<td class="address-1"><span id="63295"></span>63295</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="2">Move <span class="register">HL</span> along to the next blackboard</td>
</tr>
<tr>
<td class="address-1"><span id="63296"></span>63296</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address-1"><span id="63297"></span>63297</td>
<td class="instruction">CP 172</td>
<td class="comment-1" rowspan="1">Did ERIC write on this blackboard?</td>
</tr>
<tr>
<td class="address-1"><span id="63299"></span>63299</td>
<td class="instruction">JR NZ,63322</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="63301"></span>
<div class="comments">
<div class="paragraph">
ERIC wrote on this blackboard. Check whether he wrote the safe combination code.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="63301"></span>63301</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="63302"></span>63302</td>
<td class="instruction">LD L,159</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="32671.html">32671</a> (which holds the safe combination code)</td>
</tr>
<tr>
<td class="address-1"><span id="63304"></span>63304</td>
<td class="instruction">LD B,4</td>
<td class="comment-1" rowspan="1">There are 4 characters in the safe combination code</td>
</tr>
<tr>
<td class="address-1"><span id="63306"></span>63306</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save the pointer to the blackboard contents buffer</td>
</tr>
<tr>
<td class="address-2"><span id="63307"></span>63307</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=character written on the blackboard by ERIC</td>
</tr>
<tr>
<td class="address-1"><span id="63308"></span>63308</td>
<td class="instruction">AND 95</td>
<td class="comment-1" rowspan="1">Convert to upper case</td>
</tr>
<tr>
<td class="address-1"><span id="63310"></span>63310</td>
<td class="instruction">INC E</td>
<td class="comment-1" rowspan="1">Move <span class="register">DE</span> along to the next character on the blackboard</td>
</tr>
<tr>
<td class="address-1"><span id="63311"></span>63311</td>
<td class="instruction">CP (HL)</td>
<td class="comment-1" rowspan="1">Does the character on the blackboard match a safe combination letter?</td>
</tr>
<tr>
<td class="address-1"><span id="63312"></span>63312</td>
<td class="instruction">JR NZ,63318</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="63314"></span>63314</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Move to the next letter of the safe combination code</td>
</tr>
<tr>
<td class="address-1"><span id="63315"></span>63315</td>
<td class="instruction">DJNZ 63307</td>
<td class="comment-1" rowspan="1">Jump back until all four letters have been checked</td>
</tr>
<tr>
<td class="address-1"><span id="63317"></span>63317</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Set the zero flag to indicate a match</td>
</tr>
<tr>
<td class="address-2"><span id="63318"></span>63318</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Restore the blackboard contents buffer pointer to <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="63319"></span>63319</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="63320"></span>63320</td>
<td class="instruction">JR Z,63330</td>
<td class="comment-1" rowspan="1">Jump if ERIC got the right combination</td>
</tr>
<tr>
<td class="address-2"><span id="63322"></span>63322</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="3">Point <span class="register">DE</span> at the next blackboard contents buffer (<a href="32686.html">32686</a> or <a href="32692.html">32692</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="63323"></span>63323</td>
<td class="instruction">ADD A,6</td>
</tr>
<tr>
<td class="address-1"><span id="63325"></span>63325</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="63326"></span>63326</td>
<td class="instruction">DEC C</td>
<td class="comment-1" rowspan="1">Decrease the blackboard counter</td>
</tr>
<tr>
<td class="address-1"><span id="63327"></span>63327</td>
<td class="instruction">JR NZ,63294</td>
<td class="comment-1" rowspan="1">Jump back until all three blackboards have been checked</td>
</tr>
<tr>
<td class="address-1"><span id="63329"></span>63329</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="63330"></span>
<div class="comments">
<div class="paragraph">
ERIC got the right combination.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="63330"></span>63330</td>
<td class="instruction">CALL <a href="63668.html">63668</a></td>
<td class="comment-1" rowspan="1">Add 1000 to the score and play a celebratory tune</td>
</tr>
<tr>
<td class="address-1"><span id="63333"></span>63333</td>
<td class="instruction">LD HL,41354</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at the attribute byte for the safe</td>
</tr>
<tr>
<td class="address-1"><span id="63336"></span>63336</td>
<td class="instruction">SET 7,(HL)</td>
<td class="comment-1" rowspan="1">Alter the attribute byte of the safe in the skool attribute data to make it flash</td>
</tr>
<tr>
<td class="address-1"><span id="63338"></span>63338</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Point <span class="register">DE</span> at the attribute byte for the safe</td>
</tr>
<tr>
<td class="address-1"><span id="63339"></span>63339</td>
<td class="instruction">CALL <a href="62674.html">62674</a></td>
<td class="comment-1" rowspan="1">Get the attribute file address of the safe in <span class="register">HL</span></td>
</tr>
<tr>
<td class="address-1"><span id="63342"></span>63342</td>
<td class="instruction">RET C</td>
<td class="comment-1" rowspan="1">Return if the safe is off-screen (unlikely!)</td>
</tr>
<tr>
<td class="address-1"><span id="63343"></span>63343</td>
<td class="instruction">SET 7,(HL)</td>
<td class="comment-1" rowspan="1">Adjust the on-screen attribute byte of the safe to make it flash</td>
</tr>
<tr>
<td class="address-1"><span id="63345"></span>63345</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="63242.html">63242</a>
</td>
<td class="up">Up: <a href="../maps/all.html#63270">Map</a></td>
<td class="next">
Next: <a href="63346.html">63346</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze RAM disassembly 20191114</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.0.</div>
<div><a href="../../asm/F726.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>