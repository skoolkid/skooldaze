<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at 26471</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Skool Daze" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="26450.html">26450</a>
</td>
<td class="up">Up: <a href="../maps/all.html#26471">Map</a></td>
<td class="next">
Next: <a href="26572.html">26572</a>
</td>
</tr>
</table>
<div class="description">26471: Main loop</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Entered from the routine at <a href="63768.html">63768</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="26471"></span>26471</td>
<td class="instruction">LD HL,(32759)</td>
<td class="comment-1" rowspan="1"><a href="32759.html">32759</a> holds the lesson clock</td>
</tr>
<tr>
<td class="address-1"><span id="26474"></span>26474</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="4">Decrease it by 1 and set the zero flag if it's time to ring the bell</td>
</tr>
<tr>
<td class="address-1"><span id="26475"></span>26475</td>
<td class="instruction">LD A,H</td>
</tr>
<tr>
<td class="address-1"><span id="26476"></span>26476</td>
<td class="instruction">OR L</td>
</tr>
<tr>
<td class="address-1"><span id="26477"></span>26477</td>
<td class="instruction">LD (32759),HL</td>
</tr>
<tr>
<td class="address-1"><span id="26480"></span>26480</td>
<td class="instruction">CALL Z,<a href="26342.html">26342</a></td>
<td class="comment-1" rowspan="1">Change the lesson if the lesson clock reached zero</td>
</tr>
<tr>
<td class="address-1"><span id="26483"></span>26483</td>
<td class="instruction">CALL <a href="25126.html">25126</a></td>
<td class="comment-1" rowspan="1">Move the characters</td>
</tr>
<tr>
<td class="address-1"><span id="26486"></span>26486</td>
<td class="instruction">CALL <a href="27353.html">27353</a></td>
<td class="comment-1" rowspan="1">Move ERIC</td>
</tr>
<tr>
<td class="address-1"><span id="26489"></span>26489</td>
<td class="instruction">JR C,26556</td>
<td class="comment-1" rowspan="1">Jump if ERIC has already been dealt with</td>
</tr>
<tr>
<td class="address-1"><span id="26491"></span>26491</td>
<td class="instruction">LD HL,32744</td>
<td class="comment-1" rowspan="2">Decrement ERIC's main action timer at <a href="32744.html">32744</a></td>
</tr>
<tr>
<td class="address-1"><span id="26494"></span>26494</td>
<td class="instruction">DEC (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="26495"></span>26495</td>
<td class="instruction">JR NZ,26556</td>
<td class="comment-1" rowspan="1">Jump unless it's time to deal with ERIC</td>
</tr>
<tr>
<td class="address-1"><span id="26497"></span>26497</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="2">Pick up the midstride indicator at <a href="32745.html">32745</a></td>
</tr>
<tr>
<td class="address-1"><span id="26498"></span>26498</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="26499"></span>26499</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1">Is ERIC midstride?</td>
</tr>
<tr>
<td class="address-1"><span id="26500"></span>26500</td>
<td class="instruction">JR Z,26507</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="26502"></span>26502</td>
<td class="instruction">CALL <a href="25856.html">25856</a></td>
<td class="comment-1" rowspan="1">Move ERIC from the midstride position, then scroll the screen left or right if necessary</td>
</tr>
<tr>
<td class="address-1"><span id="26505"></span>26505</td>
<td class="instruction">JR 26559</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="26507"></span>
<div class="comments">
<div class="paragraph">
Time to check the keyboard (or simulate a keypress in demo mode) to see how ERIC should move next.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="26507"></span>26507</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="2">Reset ERIC's main action timer at <a href="32744.html">32744</a> to 9</td>
</tr>
<tr>
<td class="address-1"><span id="26508"></span>26508</td>
<td class="instruction">LD (HL),9</td>
</tr>
<tr>
<td class="address-1"><span id="26510"></span>26510</td>
<td class="instruction">CALL <a href="62938.html">62938</a></td>
<td class="comment-1" rowspan="1">Collect or simulate a keypress</td>
</tr>
<tr>
<td class="address-1"><span id="26513"></span>26513</td>
<td class="instruction">JR Z,26556</td>
<td class="comment-1" rowspan="1">Jump if no relevant keypress was collected or simulated</td>
</tr>
<tr>
<td class="address-1"><span id="26515"></span>26515</td>
<td class="instruction">LD HL,32763</td>
<td class="comment-1" rowspan="1"><a href="32763.html">32763</a> holds ERIC's status flags</td>
</tr>
<tr>
<td class="address-1"><span id="26518"></span>26518</td>
<td class="instruction">BIT 5,(HL)</td>
<td class="comment-1" rowspan="1">Is ERIC writing on a blackboard?</td>
</tr>
<tr>
<td class="address-1"><span id="26520"></span>26520</td>
<td class="instruction">JR Z,26527</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="26522"></span>26522</td>
<td class="instruction">CALL <a href="63146.html">63146</a></td>
<td class="comment-1" rowspan="1">Deal with keypresses while ERIC is writing on the board</td>
</tr>
<tr>
<td class="address-1"><span id="26525"></span>26525</td>
<td class="instruction">JR 26556</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-2"><span id="26527"></span>26527</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="2"><span class="register">DE</span>=<a href="32764.html">32764</a> (which holds the ASCII code of the last keypress)</td>
</tr>
<tr>
<td class="address-1"><span id="26528"></span>26528</td>
<td class="instruction">EX DE,HL</td>
</tr>
<tr>
<td class="address-1"><span id="26529"></span>26529</td>
<td class="instruction">CP 32</td>
<td class="comment-1" rowspan="1">Was the keypress ASCII code &gt;= 32?</td>
</tr>
<tr>
<td class="address-1"><span id="26531"></span>26531</td>
<td class="instruction">JR C,26556</td>
<td class="comment-1" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="address-1"><span id="26533"></span>26533</td>
<td class="instruction">LD HL,26556</td>
<td class="comment-1" rowspan="2">Push the address of the entry point at <a href="26471.html#26556">26556</a> (see below) onto the stack</td>
</tr>
<tr>
<td class="address-1"><span id="26536"></span>26536</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="address-1"><span id="26537"></span>26537</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="3">Point <span class="register">HL</span> at the appropriate entry in the <a href="26656.html">keypress offset table</a></td>
</tr>
<tr>
<td class="address-1"><span id="26538"></span>26538</td>
<td class="instruction">LD H,104</td>
</tr>
<tr>
<td class="address-1"><span id="26540"></span>26540</td>
<td class="instruction">LD L,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="26541"></span>26541</td>
<td class="instruction">LDI</td>
<td class="comment-1" rowspan="1">Copy the ASCII code of the keypress into <a href="32764.html">32764</a></td>
</tr>
<tr>
<td class="address-1"><span id="26543"></span>26543</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-1" rowspan="3">Pick up in <span class="register">DE</span> the address of the appropriate routine for dealing with the keypress</td>
</tr>
<tr>
<td class="address-1"><span id="26544"></span>26544</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="26545"></span>26545</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="26546"></span>26546</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Push this address onto the stack</td>
</tr>
<tr>
<td class="address-1"><span id="26547"></span>26547</td>
<td class="instruction">LD HL,44128</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at byte 96 of ERIC's buffer</td>
</tr>
<tr>
<td class="address-1"><span id="26550"></span>26550</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-1" rowspan="5">Pick up ERIC's animatory state in <span class="register">B</span> and his coordinates in <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="26551"></span>26551</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="26552"></span>26552</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="26553"></span>26553</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="26554"></span>26554</td>
<td class="instruction">LD E,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="26555"></span>26555</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Make an indirect jump to the appropriate routine for dealing with ERIC, then return to <a href="26471.html#26556">26556</a> below</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="26556"></span>
<div class="comments">
<div class="paragraph">
Now that ERIC has been moved or otherwise dealt with, update the display.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="26556"></span>26556</td>
<td class="instruction">CALL <a href="27026.html">27026</a></td>
<td class="comment-1" rowspan="1">Update the display</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="26559"></span>
<div class="comments">
<div class="paragraph">
The next section of code ensures that we don't pass through the main loop more than once every 20 milliseconds.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="26559"></span>26559</td>
<td class="instruction">LD HL,32762</td>
<td class="comment-1" rowspan="5">Wait until the system variable FRAMES at 23672 has been incremented since the last time it was checked (FRAMES is incremented every 20ms)</td>
</tr>
<tr>
<td class="address-2"><span id="26562"></span>26562</td>
<td class="instruction">LD A,(23672)</td>
</tr>
<tr>
<td class="address-1"><span id="26565"></span>26565</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="26566"></span>26566</td>
<td class="instruction">JR Z,26562</td>
</tr>
<tr>
<td class="address-1"><span id="26568"></span>26568</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address-1"><span id="26569"></span>26569</td>
<td class="instruction">JP 26471</td>
<td class="comment-1" rowspan="1">Jump back to the beginning of the main loop</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="26450.html">26450</a>
</td>
<td class="up">Up: <a href="../maps/all.html#26471">Map</a></td>
<td class="next">
Next: <a href="26572.html">26572</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze RAM disassembly 20200809</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../../asm/6767.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>