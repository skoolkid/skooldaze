<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at 29871</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Skool Daze" src="../../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="29868.html">29868</a></span></td>
<td class="up">Up: <a href="../maps/all.html#29871">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="29972.html">29972</a></span></td>
</tr>
</table>
<div class="description">29871: Save the area of the screen that will be overwritten by a lines bubble</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="30464.html">30464</a> and <a href="63829.html">63829</a>. Returns with the carry flag set if the teacher whose coordinates are in <span class="register">DE</span> is off-screen. Otherwise calculates the position of the lines bubble and copies the area of the screen that would be overwritten by the bubble to the buffer at <a href="59904.html">59904</a>, and returns with <span class="register">DE</span> holding the attribute file address for the top-left corner of the lines bubble.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">DE</td>
<td class="register-desc">Teacher's coordinates</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="29871"></span>29871</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,(32512)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=leftmost column of the skool on screen (0-64)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29874"></span>29874</td>
<td class="bytes-0"></td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">Copy this to <span class="register">B</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29875"></span>29875</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=teacher's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29876"></span>29876</td>
<td class="bytes-0"></td>
<td class="instruction">AND 248</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29878"></span>29878</td>
<td class="bytes-0"></td>
<td class="instruction">SUB B</td>
<td class="comment-11" rowspan="1">Is the teacher off-screen to the left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29879"></span>29879</td>
<td class="bytes-0"></td>
<td class="instruction">RET C</td>
<td class="comment-11" rowspan="1">Return with the carry flag set if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29880"></span>29880</td>
<td class="bytes-0"></td>
<td class="instruction">CP 32</td>
<td class="comment-11" rowspan="1">Is the teacher off-screen to the right?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29882"></span>29882</td>
<td class="bytes-0"></td>
<td class="instruction">CCF</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29883"></span>29883</td>
<td class="bytes-0"></td>
<td class="instruction">RET C</td>
<td class="comment-11" rowspan="1">Return with the carry flag set if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="29884"></span>
<div class="comments">
<div class="paragraph">
The teacher is on screen. First, save the attribute bytes of the area of the screen that will be overwritten by the lines bubble.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29884"></span>29884</td>
<td class="bytes-0"></td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=teacher's screen x-coordinate (0-31)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29885"></span>29885</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=teacher's y-coordinate (152-169)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29886"></span>29886</td>
<td class="bytes-0"></td>
<td class="instruction">SUB 155</td>
<td class="comment-11" rowspan="3"><span class="register">A</span>=teacher's screen y-coordinate (0-14)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29888"></span>29888</td>
<td class="bytes-0"></td>
<td class="instruction">JR NC,29891</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29890"></span>29890</td>
<td class="bytes-0"></td>
<td class="instruction">XOR A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="29891"></span>29891</td>
<td class="bytes-0"></td>
<td class="instruction">RRCA</td>
<td class="comment-11" rowspan="11">Set <span class="register">DE</span> to the attribute file address of the top left corner of the lines bubble</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29892"></span>29892</td>
<td class="bytes-0"></td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29893"></span>29893</td>
<td class="bytes-0"></td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29894"></span>29894</td>
<td class="bytes-0"></td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29895"></span>29895</td>
<td class="bytes-0"></td>
<td class="instruction">AND 224</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29897"></span>29897</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29898"></span>29898</td>
<td class="bytes-0"></td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29899"></span>29899</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29900"></span>29900</td>
<td class="bytes-0"></td>
<td class="instruction">AND 3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29902"></span>29902</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,88</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29904"></span>29904</td>
<td class="bytes-0"></td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29905"></span>29905</td>
<td class="bytes-0"></td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29906"></span>29906</td>
<td class="bytes-0"></td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29907"></span>29907</td>
<td class="bytes-0"></td>
<td class="instruction">LD HL,59904</td>
<td class="comment-11" rowspan="1">The buffer at <a href="59904.html">59904</a> will store the area of the screen overwritten by the lines bubble</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29910"></span>29910</td>
<td class="bytes-0"></td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1"><span class="register">DE</span>=<a href="59904.html">59904</a>, <span class="register">HL</span>=attribute file address</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29911"></span>29911</td>
<td class="bytes-0"></td>
<td class="instruction">LD BC,8</td>
<td class="comment-11" rowspan="10">Copy the 24 attribute bytes that will be overwritten by the lines bubble from the screen to <a href="59904.html">59904</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29914"></span>29914</td>
<td class="bytes-0"></td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29916"></span>29916</td>
<td class="bytes-0"></td>
<td class="instruction">LD C,24</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29918"></span>29918</td>
<td class="bytes-0"></td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29919"></span>29919</td>
<td class="bytes-0"></td>
<td class="instruction">LD C,8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29921"></span>29921</td>
<td class="bytes-0"></td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29923"></span>29923</td>
<td class="bytes-0"></td>
<td class="instruction">LD C,24</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29925"></span>29925</td>
<td class="bytes-0"></td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29926"></span>29926</td>
<td class="bytes-0"></td>
<td class="instruction">LD C,8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29928"></span>29928</td>
<td class="bytes-0"></td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="29930"></span>
<div class="comments">
<div class="paragraph">
Next, save the display file bytes of the area of the screen that will be overwritten by the lines bubble.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29930"></span>29930</td>
<td class="bytes-0"></td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="2">Restore the attribute file address of the top-left corner of the lines bubble to <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29931"></span>29931</td>
<td class="bytes-0"></td>
<td class="instruction">PUSH HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29932"></span>29932</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="6">Get the display file address of the top-left corner of the lines bubble in <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29933"></span>29933</td>
<td class="bytes-0"></td>
<td class="instruction">SUB 80</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29935"></span>29935</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29936"></span>29936</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29937"></span>29937</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29938"></span>29938</td>
<td class="bytes-0"></td>
<td class="instruction">LD H,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29939"></span>29939</td>
<td class="bytes-0"></td>
<td class="instruction">LD BC,3</td>
<td class="comment-11" rowspan="1">A lines bubble has 3 rows...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="29942"></span>29942</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,8</td>
<td class="comment-11" rowspan="19">...and 8 columns; copy the 192 display file bytes that will be overwritten by the lines bubble from the screen to <a href="59904.html#59928">59928</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29944"></span>29944</td>
<td class="bytes-0"></td>
<td class="instruction">PUSH BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="29945"></span>29945</td>
<td class="bytes-0"></td>
<td class="instruction">PUSH HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29946"></span>29946</td>
<td class="bytes-0"></td>
<td class="instruction">LD C,8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29948"></span>29948</td>
<td class="bytes-0"></td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29950"></span>29950</td>
<td class="bytes-0"></td>
<td class="instruction">POP HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29951"></span>29951</td>
<td class="bytes-0"></td>
<td class="instruction">INC H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29952"></span>29952</td>
<td class="bytes-0"></td>
<td class="instruction">DEC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29953"></span>29953</td>
<td class="bytes-0"></td>
<td class="instruction">JR NZ,29945</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29955"></span>29955</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29956"></span>29956</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,32</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29958"></span>29958</td>
<td class="bytes-0"></td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29959"></span>29959</td>
<td class="bytes-0"></td>
<td class="instruction">JR C,29965</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29961"></span>29961</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29962"></span>29962</td>
<td class="bytes-0"></td>
<td class="instruction">SUB 8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29964"></span>29964</td>
<td class="bytes-0"></td>
<td class="instruction">LD H,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><span id="29965"></span>29965</td>
<td class="bytes-0"></td>
<td class="instruction">POP BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29966"></span>29966</td>
<td class="bytes-0"></td>
<td class="instruction">DEC C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29967"></span>29967</td>
<td class="bytes-0"></td>
<td class="instruction">JR NZ,29942</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29969"></span>29969</td>
<td class="bytes-0"></td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">Restore the attribute file address of the top-left corner of the lines bubble to <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29970"></span>29970</td>
<td class="bytes-0"></td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><span id="29971"></span>29971</td>
<td class="bytes-0"></td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Return with the carry flag reset</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="29868.html">29868</a></span></td>
<td class="up">Up: <a href="../maps/all.html#29871">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="29972.html">29972</a></span></td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze RAM disassembly 20190614</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 7.2.</div>
<div><a href="../../asm/74AF.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>