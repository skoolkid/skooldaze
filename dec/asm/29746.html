<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at 29746</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Skool Daze" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="29735.html">29735</a>
</td>
<td class="up">Up: <a href="../maps/all.html#29746">Map</a></td>
<td class="next">
Next: <a href="29868.html">29868</a>
</td>
</tr>
</table>
<div class="description">29746: Remove the speech bubble</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="31130.html">31130</a> and <a href="32470.html">32470</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Number of the character who is speaking (152-169)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="29746"></span>29746</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Save the character number</td>
</tr>
<tr>
<td class="address-1"><span id="29747"></span>29747</td>
<td class="instruction">CALL <a href="29394.html">29394</a></td>
<td class="comment-1" rowspan="1">Is the speech bubble off-screen?</td>
</tr>
<tr>
<td class="address-1"><span id="29750"></span>29750</td>
<td class="instruction">JR C,29815</td>
<td class="comment-1" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="address-1"><span id="29752"></span>29752</td>
<td class="instruction">CALL <a href="29735.html">29735</a></td>
<td class="comment-1" rowspan="1">Update the SRB for the part of the screen hidden by the speech bubble</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="29755"></span>
<div class="comments">
<div class="paragraph">
First, restore the original attribute bytes for the area of the screen occupied by the speech bubble.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="29755"></span>29755</td>
<td class="instruction">LD DE,(32612)</td>
<td class="comment-1" rowspan="1">Copy the speech bubble lip coordinates from <a href="32612.html">32612</a> to <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="29759"></span>29759</td>
<td class="instruction">CALL <a href="28807.html">28807</a></td>
<td class="comment-1" rowspan="1">Update the SRB for the part of the screen hidden by the lip</td>
</tr>
<tr>
<td class="address-1"><span id="29762"></span>29762</td>
<td class="instruction">LD HL,32512</td>
<td class="comment-1" rowspan="1"><a href="32512.html">32512</a> holds the leftmost column of the skool on screen (0-64)</td>
</tr>
<tr>
<td class="address-1"><span id="29765"></span>29765</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="3"><span class="register">E</span>=screen x-coordinate of the speech bubble lip (0-31)</td>
</tr>
<tr>
<td class="address-1"><span id="29766"></span>29766</td>
<td class="instruction">SUB (HL)</td>
</tr>
<tr>
<td class="address-1"><span id="29767"></span>29767</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="29768"></span>29768</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=screen y-coordinate of the speech bubble lip (2-17)</td>
</tr>
<tr>
<td class="address-1"><span id="29769"></span>29769</td>
<td class="instruction">SUB 152</td>
</tr>
<tr>
<td class="address-1"><span id="29771"></span>29771</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="11">Set <span class="register">DE</span> to the attribute file address corresponding to the lip of the speech bubble</td>
</tr>
<tr>
<td class="address-1"><span id="29772"></span>29772</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="29773"></span>29773</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="29774"></span>29774</td>
<td class="instruction">LD D,A</td>
</tr>
<tr>
<td class="address-1"><span id="29775"></span>29775</td>
<td class="instruction">AND 224</td>
</tr>
<tr>
<td class="address-1"><span id="29777"></span>29777</td>
<td class="instruction">ADD A,E</td>
</tr>
<tr>
<td class="address-1"><span id="29778"></span>29778</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="29779"></span>29779</td>
<td class="instruction">LD A,D</td>
</tr>
<tr>
<td class="address-1"><span id="29780"></span>29780</td>
<td class="instruction">AND 3</td>
</tr>
<tr>
<td class="address-1"><span id="29782"></span>29782</td>
<td class="instruction">ADD A,88</td>
</tr>
<tr>
<td class="address-1"><span id="29784"></span>29784</td>
<td class="instruction">LD D,A</td>
</tr>
<tr>
<td class="address-1"><span id="29785"></span>29785</td>
<td class="instruction">LD L,103</td>
<td class="comment-1" rowspan="3">Pick up the attribute byte for the part of screen hidden by the speech bubble lip from <a href="32614.html#32615">32615</a> and restore it to the attribute file</td>
</tr>
<tr>
<td class="address-1"><span id="29787"></span>29787</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="29788"></span>29788</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="address-1"><span id="29789"></span>29789</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="7">Point <span class="register">DE</span> at the attribute file address corresponding to the top left corner of the speech bubble</td>
</tr>
<tr>
<td class="address-1"><span id="29790"></span>29790</td>
<td class="instruction">LD BC,65472</td>
</tr>
<tr>
<td class="address-1"><span id="29793"></span>29793</td>
<td class="instruction">ADD HL,BC</td>
</tr>
<tr>
<td class="address-1"><span id="29794"></span>29794</td>
<td class="instruction">LD A,L</td>
</tr>
<tr>
<td class="address-1"><span id="29795"></span>29795</td>
<td class="instruction">AND 248</td>
</tr>
<tr>
<td class="address-1"><span id="29797"></span>29797</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address-1"><span id="29798"></span>29798</td>
<td class="instruction">EX DE,HL</td>
</tr>
<tr>
<td class="address-1"><span id="29799"></span>29799</td>
<td class="instruction">LD BC,8</td>
<td class="comment-1" rowspan="3">Restore the attribute bytes of the part of the screen overwritten by the top row of the speech bubble (stored at <a href="32614.html#32632">32632</a> by the routine at <a href="29518.html">29518</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="29802"></span>29802</td>
<td class="instruction">LD L,120</td>
</tr>
<tr>
<td class="address-1"><span id="29804"></span>29804</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="29806"></span>29806</td>
<td class="instruction">LD C,24</td>
<td class="comment-1" rowspan="4">Point <span class="register">DE</span> at the attribute file address corresponding to the bottom left corner of the speech bubble</td>
</tr>
<tr>
<td class="address-1"><span id="29808"></span>29808</td>
<td class="instruction">EX DE,HL</td>
</tr>
<tr>
<td class="address-1"><span id="29809"></span>29809</td>
<td class="instruction">ADD HL,BC</td>
</tr>
<tr>
<td class="address-1"><span id="29810"></span>29810</td>
<td class="instruction">EX DE,HL</td>
</tr>
<tr>
<td class="address-1"><span id="29811"></span>29811</td>
<td class="instruction">LD C,8</td>
<td class="comment-1" rowspan="2">Restore the attribute bytes of the part of the screen overwritten by the bottom row of the speech bubble (stored at <a href="32614.html#32640">32640</a> by the routine at <a href="29518.html">29518</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="29813"></span>29813</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="29815"></span>
<div class="comments">
<div class="paragraph">
Next, restore the skool UDG references and attribute bytes for the area of the skool occupied by the speech bubble.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-2"><span id="29815"></span>29815</td>
<td class="instruction">LD DE,(32612)</td>
<td class="comment-1" rowspan="1">Copy the speech bubble lip coordinates from <a href="32612.html">32612</a> to <span class="register">DE</span></td>
</tr>
<tr>
<td class="address-1"><span id="29819"></span>29819</td>
<td class="instruction">LD HL,32614</td>
<td class="comment-1" rowspan="4">Pick up the UDG reference for the part of the skool occupied by the speech bubble lip and restore it</td>
</tr>
<tr>
<td class="address-1"><span id="29822"></span>29822</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="29823"></span>29823</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="29824"></span>29824</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="address-1"><span id="29825"></span>29825</td>
<td class="instruction">SET 7,E</td>
<td class="comment-1" rowspan="4">Pick up the attribute byte for the part of the skool occupied by the speech bubble lip and restore it</td>
</tr>
<tr>
<td class="address-1"><span id="29827"></span>29827</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address-1"><span id="29828"></span>29828</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address-1"><span id="29829"></span>29829</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="address-1"><span id="29830"></span>29830</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="5"><span class="register">DE</span>=coordinates of the top left corner of the speech bubble</td>
</tr>
<tr>
<td class="address-1"><span id="29831"></span>29831</td>
<td class="instruction">AND 120</td>
</tr>
<tr>
<td class="address-1"><span id="29833"></span>29833</td>
<td class="instruction">DEC D</td>
</tr>
<tr>
<td class="address-1"><span id="29834"></span>29834</td>
<td class="instruction">DEC D</td>
</tr>
<tr>
<td class="address-1"><span id="29835"></span>29835</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="29836"></span>29836</td>
<td class="instruction">LD BC,8</td>
<td class="comment-1" rowspan="2">Restore the UDG references of the part of the skool overwritten by the top row of the speech bubble (stored at <a href="32614.html#32616">32616</a> by the routine at <a href="29518.html">29518</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="29839"></span>29839</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="29841"></span>29841</td>
<td class="instruction">INC D</td>
<td class="comment-1" rowspan="4">Restore the UDG references of the part of the skool overwritten by the bottom row of the speech bubble (stored at <a href="32614.html#32624">32624</a> by the routine at <a href="29518.html">29518</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="29842"></span>29842</td>
<td class="instruction">LD C,8</td>
</tr>
<tr>
<td class="address-1"><span id="29844"></span>29844</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="29845"></span>29845</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="29847"></span>29847</td>
<td class="instruction">ADD A,128</td>
<td class="comment-1" rowspan="3">Point <span class="register">DE</span> at the skool graphic data attribute byte corresponding to the top-left corner of the speech bubble</td>
</tr>
<tr>
<td class="address-1"><span id="29849"></span>29849</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="29850"></span>29850</td>
<td class="instruction">DEC D</td>
</tr>
<tr>
<td class="address-1"><span id="29851"></span>29851</td>
<td class="instruction">LD C,8</td>
<td class="comment-1" rowspan="2">Restore the attribute bytes of the part of the skool overwritten by the top row of the speech bubble (stored at <a href="32614.html#32632">32632</a> by the routine at <a href="29518.html">29518</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="29853"></span>29853</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="address-1"><span id="29855"></span>29855</td>
<td class="instruction">INC D</td>
<td class="comment-1" rowspan="4">Restore the attribute bytes of the part of the skool overwritten by the bottom row of the speech bubble (stored at <a href="32614.html#32640">32640</a> by the routine at <a href="29518.html">29518</a>)</td>
</tr>
<tr>
<td class="address-1"><span id="29856"></span>29856</td>
<td class="instruction">LD C,8</td>
</tr>
<tr>
<td class="address-1"><span id="29858"></span>29858</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address-1"><span id="29859"></span>29859</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="29861"></span>
<div class="comments">
<div class="paragraph">
Finally, clear the speech bubble lip coordinates (at <a href="32612.html">32612</a>) to indicate that no one is speaking.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="29861"></span>29861</td>
<td class="instruction">LD (32612),BC</td>
<td class="comment-1" rowspan="1">Set the speech bubble lip coordinates at to (0,0)</td>
</tr>
<tr>
<td class="address-1"><span id="29865"></span>29865</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the speaker's character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="address-1"><span id="29866"></span>29866</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="address-1"><span id="29867"></span>29867</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="29735.html">29735</a>
</td>
<td class="up">Up: <a href="../maps/all.html#29746">Map</a></td>
<td class="next">
Next: <a href="29868.html">29868</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze RAM disassembly 20210310</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd. &#169; 2021 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.4.</div>
<div><a href="../../asm/7432.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>