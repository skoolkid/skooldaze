<!DOCTYPE html>
<html>
<head>
<title>Skool Daze: Routine at 62674</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Skool Daze" src="../../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="62669.html">62669</a>
</td>
<td class="up">Up: <a href="../maps/all.html#62674">Map</a></td>
<td class="next">
Next: <a href="62705.html">62705</a>
</td>
</tr>
</table>
<div class="description">62674: Get the attribute file address of a pellet's potential target or the safe</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="28143.html">28143</a> (to check whether a shield has been hit) and <a href="63270.html">63270</a> (to make the safe flash). If the pellet's potential target or the safe is on-screen, this routine returns with the carry flag reset and <span class="register">HL</span> holding the attribute file address.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">D</td>
<td class="register-desc">Target y-coordinate</td>
</tr>
<tr>
<td class="register">E</td>
<td class="register-desc">128 + target x-coordinate</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="address-2"><span id="62674"></span>62674</td>
<td class="instruction">LD HL,32512</td>
<td class="comment-1" rowspan="1"><a href="32512.html">32512</a> holds the leftmost column of the skool on screen (0-64)</td>
</tr>
<tr>
<td class="address-1"><span id="62677"></span>62677</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="2">Set <span class="register">A</span> to the true x-coordinate of the potential target</td>
</tr>
<tr>
<td class="address-1"><span id="62678"></span>62678</td>
<td class="instruction">AND 127</td>
</tr>
<tr>
<td class="address-1"><span id="62680"></span>62680</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-1" rowspan="2">Return with the carry flag set if the pellet is off-screen to the left</td>
</tr>
<tr>
<td class="address-1"><span id="62681"></span>62681</td>
<td class="instruction">RET C</td>
</tr>
<tr>
<td class="address-1"><span id="62682"></span>62682</td>
<td class="instruction">CP 32</td>
<td class="comment-1" rowspan="1">The screen is 32 columns wide</td>
</tr>
<tr>
<td class="address-1"><span id="62684"></span>62684</td>
<td class="instruction">CCF</td>
<td class="comment-1" rowspan="2">Return with carry flag set if the pellet is off-screen to the right</td>
</tr>
<tr>
<td class="address-1"><span id="62685"></span>62685</td>
<td class="instruction">RET C</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="62686"></span>
<div class="comments">
<div class="paragraph">
The potential target is on-screen.
</div>
</div>
</td>
</tr>
<tr>
<td class="address-1"><span id="62686"></span>62686</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1"><span class="register">L</span>=screen x-coordinate (0-31) of the potential target</td>
</tr>
<tr>
<td class="address-1"><span id="62687"></span>62687</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=screen y-coordinate (2, 8 or 14) of the potential target</td>
</tr>
<tr>
<td class="address-1"><span id="62688"></span>62688</td>
<td class="instruction">SUB 152</td>
</tr>
<tr>
<td class="address-1"><span id="62690"></span>62690</td>
<td class="instruction">RRCA</td>
<td class="comment-1" rowspan="3"><span class="register">A</span>=64 (top floor), 1 (middle floor), or 193 (bottom floor</td>
</tr>
<tr>
<td class="address-1"><span id="62691"></span>62691</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="62692"></span>62692</td>
<td class="instruction">RRCA</td>
</tr>
<tr>
<td class="address-1"><span id="62693"></span>62693</td>
<td class="instruction">LD H,A</td>
<td class="comment-1" rowspan="1">Save this floor indicator in <span class="register">H</span> for now</td>
</tr>
<tr>
<td class="address-1"><span id="62694"></span>62694</td>
<td class="instruction">AND 224</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=64 (top floor), 0 (middle) or 192 (bottom)</td>
</tr>
<tr>
<td class="address-1"><span id="62696"></span>62696</td>
<td class="instruction">ADD A,L</td>
<td class="comment-1" rowspan="1">Add the screen x-coordinate to get the LSB of the attribute file address of the potential target</td>
</tr>
<tr>
<td class="address-1"><span id="62697"></span>62697</td>
<td class="instruction">LD L,A</td>
<td class="comment-1" rowspan="1">Copy the LSB to <span class="register">L</span></td>
</tr>
<tr>
<td class="address-1"><span id="62698"></span>62698</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=0 (top floor) or 1 (middle floor or bottom floor)</td>
</tr>
<tr>
<td class="address-1"><span id="62699"></span>62699</td>
<td class="instruction">AND 3</td>
</tr>
<tr>
<td class="address-1"><span id="62701"></span>62701</td>
<td class="instruction">ADD A,88</td>
<td class="comment-1" rowspan="1">Add 88 to get the MSB of the attribute file address of the potential target</td>
</tr>
<tr>
<td class="address-1"><span id="62703"></span>62703</td>
<td class="instruction">LD H,A</td>
<td class="comment-1" rowspan="1">Copy the MSB to <span class="register">H</span></td>
</tr>
<tr>
<td class="address-1"><span id="62704"></span>62704</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return with the carry flag reset</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="62669.html">62669</a>
</td>
<td class="up">Up: <a href="../maps/all.html#62674">Map</a></td>
<td class="next">
Next: <a href="62705.html">62705</a>
</td>
</tr>
</table>
<footer>
<div class="release">The complete Skool Daze RAM disassembly 20191114</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.0.</div>
<div><a href="../../asm/F4D2.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>